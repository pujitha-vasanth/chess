<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#000000">
  <title>Chess</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { overscroll-behavior: none; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #000; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBl_hoQ27DPlc1A3V6IgulogY5TvwGBW7c",
      authDomain: "chess-d29d2.firebaseapp.com",
      databaseURL: "https://chess-d29d2-default-rtdb.firebaseio.com",
      projectId: "chess-d29d2",
      storageBucket: "chess-d29d2.firebasestorage.app",
      messagingSenderId: "81534677072",
      appId: "1:81534677072:web:fe78bfa92d7d3903fb6155",
      measurementId: "G-WR8FZS72QQ"
    };
    try {
      firebase.initializeApp(firebaseConfig);
      window.firebaseDatabase = firebase.database();
    } catch (e) {
      console.error('Firebase init error:', e);
      window.firebaseDatabase = null;
    }
  </script>
  <script type="text/babel">
const { useState, useCallback, useEffect, useRef } = React;



const INITIAL_BOARD = [
  ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r'],
  ['p', 'p', 'p', 'p', 'p', 'p', 'p', 'p'],
  [null, null, null, null, null, null, null, null],
  [null, null, null, null, null, null, null, null],
  [null, null, null, null, null, null, null, null],
  [null, null, null, null, null, null, null, null],
  ['P', 'P', 'P', 'P', 'P', 'P', 'P', 'P'],
  ['R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R']
];

const PIECE_VALUES = { p: 1, n: 3, b: 3, r: 5, q: 9, k: 0 };

// Standard Chess Piece SVGs - Clean and recognizable
const WhiteKing = () => (
  <svg viewBox="0 0 45 45" className="w-full h-full">
    <g fill="#fff" stroke="#000" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
      <path strokeLinejoin="miter" d="M22.5 11.63V6M20 8h5"/>
      <path strokeLinecap="butt" strokeLinejoin="miter" d="M22.5 25s4.5-7.5 3-10.5c0 0-1-2.5-3-2.5s-3 2.5-3 2.5c-1.5 3 3 10.5 3 10.5"/>
      <path d="M11.5 37c5.5 3.5 15.5 3.5 21 0v-7s9-4.5 6-10.5c-4-6.5-13.5-3.5-16 4V27v-3.5c-3.5-7.5-13-10.5-16-4-3 6 5 10 5 10V37z"/>
      <path d="M11.5 30c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0"/>
    </g>
  </svg>
);

const WhiteQueen = () => (
  <svg viewBox="0 0 45 45" className="w-full h-full">
    <g fill="#fff" stroke="#000" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
      <path d="M8 12a2 2 0 1 1-4 0 2 2 0 1 1 4 0zm16.5-4.5a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM41 12a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM16 8.5a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM33 9a2 2 0 1 1-4 0 2 2 0 1 1 4 0z"/>
      <path strokeLinecap="butt" d="M9 26c8.5-1.5 21-1.5 27 0l2-12-7 11V11l-5.5 13.5-3-15-3 15-5.5-14V25L7 14l2 12z"/>
      <path strokeLinecap="butt" d="M9 26c0 2 1.5 2 2.5 4 1 1.5 1 1 .5 3.5-1.5 1-1.5 2.5-1.5 2.5-1.5 1.5.5 2.5.5 2.5 6.5 1 16.5 1 23 0 0 0 1.5-1 0-2.5 0 0 .5-1.5-1-2.5-.5-2.5-.5-2 .5-3.5 1-2 2.5-2 2.5-4-8.5-1.5-18.5-1.5-27 0z"/>
      <path fill="none" d="M11.5 30c3.5-1 18.5-1 22 0M12 33.5c6-1 15-1 21 0"/>
    </g>
  </svg>
);

const WhiteRook = () => (
  <svg viewBox="0 0 45 45" className="w-full h-full">
    <g fill="#fff" stroke="#000" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
      <path strokeLinecap="butt" d="M9 39h27v-3H9v3zm3-3v-4h21v4H12zm-1-22V9h4v2h5V9h5v2h5V9h4v5"/>
      <path d="M34 14l-3 3H14l-3-3"/>
      <path strokeLinecap="butt" strokeLinejoin="miter" d="M31 17v12.5H14V17"/>
      <path d="M31 29.5l1.5 2.5h-20l1.5-2.5"/>
      <path fill="none" strokeLinejoin="miter" d="M11 14h23"/>
    </g>
  </svg>
);

const WhiteBishop = () => (
  <svg viewBox="0 0 45 45" className="w-full h-full">
    <g fill="#fff" stroke="#000" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
      <g strokeLinecap="butt">
        <path d="M9 36c3.39-.97 10.11.43 13.5-2 3.39 2.43 10.11 1.03 13.5 2 0 0 1.65.54 3 2-.68.97-1.65.99-3 .5-3.39-.97-10.11.46-13.5-1-3.39 1.46-10.11.03-13.5 1-1.354.49-2.323.47-3-.5 1.354-1.94 3-2 3-2z"/>
        <path d="M15 32c2.5 2.5 12.5 2.5 15 0 .5-1.5 0-2 0-2 0-2.5-2.5-4-2.5-4 5.5-1.5 6-11.5-5-15.5-11 4-10.5 14-5 15.5 0 0-2.5 1.5-2.5 4 0 0-.5.5 0 2z"/>
        <path d="M25 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 1 1 5 0z"/>
      </g>
      <path fill="none" strokeLinejoin="miter" d="M17.5 26h10M15 30h15m-7.5-14.5v5M20 18h5"/>
    </g>
  </svg>
);

const WhiteKnight = () => (
  <svg viewBox="0 0 45 45" className="w-full h-full">
    <g fill="#fff" stroke="#000" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
      <path d="M22 10c10.5 1 16.5 8 16 29H15c0-9 10-6.5 8-21"/>
      <path d="M24 18c.38 2.91-5.55 7.37-8 9-3 2-2.82 4.34-5 4-1.042-.94 1.41-3.04 0-3-1 0 .19 1.23-1 2-1 0-4.003 1-4-4 0-2 6-12 6-12s1.89-1.9 2-3.5c-.73-.994-.5-2-.5-3 1-1 3 2.5 3 2.5h2s.78-1.992 2.5-3c1 0 1 3 1 3"/>
      <path fill="#000" d="M9.5 25.5a.5.5 0 1 1-1 0 .5.5 0 1 1 1 0zm5.433-9.75a.5 1.5 30 1 1-.866-.5.5 1.5 30 1 1 .866.5z"/>
    </g>
  </svg>
);

const WhitePawn = () => (
  <svg viewBox="0 0 45 45" className="w-full h-full">
    <path d="M22.5 9c-2.21 0-4 1.79-4 4 0 .89.29 1.71.78 2.38C17.33 16.5 16 18.59 16 21c0 2.03.94 3.84 2.41 5.03-3 1.06-7.41 5.55-7.41 13.47h23c0-7.92-4.41-12.41-7.41-13.47 1.47-1.19 2.41-3 2.41-5.03 0-2.41-1.33-4.5-3.28-5.62.49-.67.78-1.49.78-2.38 0-2.21-1.79-4-4-4z" fill="#fff" stroke="#000" strokeWidth="1.5" strokeLinecap="round"/>
  </svg>
);

const BlackKing = () => (
  <svg viewBox="0 0 45 45" className="w-full h-full">
    <g fill="none" fillRule="evenodd" stroke="#000" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
      <path d="M22.5 11.63V6" strokeLinejoin="miter"/>
      <path d="M22.5 25s4.5-7.5 3-10.5c0 0-1-2.5-3-2.5s-3 2.5-3 2.5c-1.5 3 3 10.5 3 10.5" fill="#000" strokeLinecap="butt" strokeLinejoin="miter"/>
      <path d="M11.5 37c5.5 3.5 15.5 3.5 21 0v-7s9-4.5 6-10.5c-4-6.5-13.5-3.5-16 4V27v-3.5c-3.5-7.5-13-10.5-16-4-3 6 5 10 5 10V37z" fill="#000"/>
      <path d="M20 8h5" strokeLinejoin="miter"/>
      <path d="M11.5 30c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0" stroke="#fff"/>
    </g>
  </svg>
);

const BlackQueen = () => (
  <svg viewBox="0 0 45 45" className="w-full h-full">
    <g fillRule="evenodd" stroke="#000" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
      <g fill="#000">
        <circle cx="6" cy="12" r="2.75"/>
        <circle cx="14" cy="9" r="2.75"/>
        <circle cx="22.5" cy="8" r="2.75"/>
        <circle cx="31" cy="9" r="2.75"/>
        <circle cx="39" cy="12" r="2.75"/>
      </g>
      <path d="M9 26c8.5-1.5 21-1.5 27 0l2.5-12.5L31 25l-.3-14.1-5.2 13.6-3-14.5-3 14.5-5.2-13.6L14 25 6.5 13.5 9 26z" fill="#000" strokeLinecap="butt"/>
      <path d="M9 26c0 2 1.5 2 2.5 4 1 1.5 1 1 .5 3.5-1.5 1-1.5 2.5-1.5 2.5-1.5 1.5.5 2.5.5 2.5 6.5 1 16.5 1 23 0 0 0 1.5-1 0-2.5 0 0 .5-1.5-1-2.5-.5-2.5-.5-2 .5-3.5 1-2 2.5-2 2.5-4-8.5-1.5-18.5-1.5-27 0z" fill="#000" strokeLinecap="butt"/>
      <path d="M11.5 30c3.5-1 18.5-1 22 0M12 33.5c6-1 15-1 21 0" fill="none" stroke="#fff"/>
    </g>
  </svg>
);

const BlackRook = () => (
  <svg viewBox="0 0 45 45" className="w-full h-full">
    <g fillRule="evenodd" stroke="#000" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
      <path d="M9 39h27v-3H9v3zm3.5-7l1.5-2.5h17l1.5 2.5h-20zm-.5 4v-4h21v4H12z" fill="#000" strokeLinecap="butt"/>
      <path d="M14 29.5v-13h17v13H14z" fill="#000" strokeLinecap="butt" strokeLinejoin="miter"/>
      <path d="M14 16.5L11 14h23l-3 2.5H14zM11 14V9h4v2h5V9h5v2h5V9h4v5H11z" fill="#000" strokeLinecap="butt"/>
      <path d="M12 35.5h21m-20-4h19m-18-2.5h17m-17-13h17M11 14h23" fill="none" stroke="#fff" strokeWidth="1" strokeLinejoin="miter"/>
    </g>
  </svg>
);

const BlackBishop = () => (
  <svg viewBox="0 0 45 45" className="w-full h-full">
    <g fillRule="evenodd" stroke="#000" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
      <g fill="#000" strokeLinecap="butt">
        <path d="M9 36c3.39-.97 10.11.43 13.5-2 3.39 2.43 10.11 1.03 13.5 2 0 0 1.65.54 3 2-.68.97-1.65.99-3 .5-3.39-.97-10.11.46-13.5-1-3.39 1.46-10.11.03-13.5 1-1.354.49-2.323.47-3-.5 1.354-1.94 3-2 3-2z"/>
        <path d="M15 32c2.5 2.5 12.5 2.5 15 0 .5-1.5 0-2 0-2 0-2.5-2.5-4-2.5-4 5.5-1.5 6-11.5-5-15.5-11 4-10.5 14-5 15.5 0 0-2.5 1.5-2.5 4 0 0-.5.5 0 2z"/>
        <path d="M25 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 1 1 5 0z"/>
      </g>
      <path d="M17.5 26h10M15 30h15m-7.5-14.5v5M20 18h5" fill="none" stroke="#fff" strokeLinejoin="miter"/>
    </g>
  </svg>
);

const BlackKnight = () => (
  <svg viewBox="0 0 45 45" className="w-full h-full">
    <g fill="none" fillRule="evenodd" stroke="#000" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
      <path d="M22 10c10.5 1 16.5 8 16 29H15c0-9 10-6.5 8-21" fill="#000"/>
      <path d="M24 18c.38 2.91-5.55 7.37-8 9-3 2-2.82 4.34-5 4-1.042-.94 1.41-3.04 0-3-1 0 .19 1.23-1 2-1 0-4.003 1-4-4 0-2 6-12 6-12s1.89-1.9 2-3.5c-.73-.994-.5-2-.5-3 1-1 3 2.5 3 2.5h2s.78-1.992 2.5-3c1 0 1 3 1 3" fill="#000"/>
      <path d="M9.5 25.5a.5.5 0 1 1-1 0 .5.5 0 1 1 1 0zm5.433-9.75a.5 1.5 30 1 1-.866-.5.5 1.5 30 1 1 .866.5z" fill="#fff" stroke="#fff"/>
    </g>
  </svg>
);

const BlackPawn = () => (
  <svg viewBox="0 0 45 45" className="w-full h-full">
    <path d="M22.5 9c-2.21 0-4 1.79-4 4 0 .89.29 1.71.78 2.38C17.33 16.5 16 18.59 16 21c0 2.03.94 3.84 2.41 5.03-3 1.06-7.41 5.55-7.41 13.47h23c0-7.92-4.41-12.41-7.41-13.47 1.47-1.19 2.41-3 2.41-5.03 0-2.41-1.33-4.5-3.28-5.62.49-.67.78-1.49.78-2.38 0-2.21-1.79-4-4-4z" fill="#000" stroke="#000" strokeWidth="1.5" strokeLinecap="round"/>
  </svg>
);

const PIECE_COMPONENTS = { 'K': WhiteKing, 'Q': WhiteQueen, 'R': WhiteRook, 'B': WhiteBishop, 'N': WhiteKnight, 'P': WhitePawn, 'k': BlackKing, 'q': BlackQueen, 'r': BlackRook, 'b': BlackBishop, 'n': BlackKnight, 'p': BlackPawn };
const PIECE_SYMBOLS = { 'K': '‚ôî', 'Q': '‚ôï', 'R': '‚ôñ', 'B': '‚ôó', 'N': '‚ôò', 'P': '‚ôô', 'k': '‚ôö', 'q': '‚ôõ', 'r': '‚ôú', 'b': '‚ôù', 'n': '‚ôû', 'p': '‚ôü' };

const OPENINGS = {
  italian: { name: "Italian Game", description: "Classic attacking setup", playerColor: 'white', moves: [
    { from: [6, 4], to: [4, 4], notation: 'e4', voice: "Let's start with e4. This controls the center and opens lines for your pieces." },
    { from: [1, 4], to: [3, 4], notation: 'e5', voice: "Black plays e5, matching our central control." },
    { from: [7, 6], to: [5, 5], notation: 'Nf3', voice: "Knight to f3. We develop and attack the e5 pawn." },
    { from: [0, 1], to: [2, 2], notation: 'Nc6', voice: "Black defends with the knight." },
    { from: [7, 5], to: [4, 2], notation: 'Bc4', voice: "Bishop to c4. This is the Italian Game! The bishop targets f7." },
    { from: [0, 5], to: [3, 2], notation: 'Bc5', voice: "Black develops their bishop. Both sides are ready." }
  ]},
  sicilian: { name: "Sicilian Defense", description: "Sharp counter-play", playerColor: 'black', moves: [
    { from: [6, 4], to: [4, 4], notation: 'e4', voice: "White opens with e4." },
    { from: [1, 2], to: [3, 2], notation: 'c5', voice: "The Sicilian! We fight for the center asymmetrically." },
    { from: [7, 6], to: [5, 5], notation: 'Nf3', voice: "White develops, preparing d4." },
    { from: [1, 3], to: [3, 3], notation: 'd6', voice: "d6 is solid and flexible." },
    { from: [6, 3], to: [4, 3], notation: 'd4', voice: "White pushes d4." },
    { from: [3, 2], to: [4, 3], notation: 'cxd4', voice: "We capture, opening the c-file for later." }
  ]},
  queensGambit: { name: "Queen's Gambit", description: "Strategic pawn sacrifice", playerColor: 'white', moves: [
    { from: [6, 3], to: [4, 3], notation: 'd4', voice: "d4 starts the Queen's Gambit." },
    { from: [1, 3], to: [3, 3], notation: 'd5', voice: "Black responds with d5." },
    { from: [6, 2], to: [4, 2], notation: 'c4', voice: "c4, the Queen's Gambit! We offer a pawn to break Black's center." },
    { from: [1, 4], to: [3, 4], notation: 'e6', voice: "Black declines, keeping the structure solid." },
    { from: [7, 1], to: [5, 2], notation: 'Nc3', voice: "Knight to c3, pressuring d5." },
    { from: [0, 6], to: [2, 5], notation: 'Nf6', voice: "Black develops naturally." }
  ]},
  london: { name: "London System", description: "Solid and reliable", playerColor: 'white', moves: [
    { from: [6, 3], to: [4, 3], notation: 'd4', voice: "d4 starts the London System." },
    { from: [1, 3], to: [3, 3], notation: 'd5', voice: "Black plays d5." },
    { from: [7, 2], to: [4, 5], notation: 'Bf4', voice: "Bishop to f4 before e3. This is the London!" },
    { from: [0, 6], to: [2, 5], notation: 'Nf6', voice: "Black develops." },
    { from: [6, 4], to: [5, 4], notation: 'e3', voice: "Now e3. Our bishop stays active outside the pawn chain." },
    { from: [1, 4], to: [2, 4], notation: 'e6', voice: "Black's bishop is stuck. Ours is active." }
  ]},
  ruyLopez: { name: "Ruy Lopez", description: "The Spanish Game", playerColor: 'white', moves: [
    { from: [6, 4], to: [4, 4], notation: 'e4', voice: "e4, the king's pawn opening." },
    { from: [1, 4], to: [3, 4], notation: 'e5', voice: "Black responds with e5." },
    { from: [7, 6], to: [5, 5], notation: 'Nf3', voice: "Knight to f3, attacking e5." },
    { from: [0, 1], to: [2, 2], notation: 'Nc6', voice: "Black defends with the knight." },
    { from: [7, 5], to: [3, 1], notation: 'Bb5', voice: "Bishop to b5. This is the Ruy Lopez, one of the oldest openings!" },
    { from: [1, 0], to: [2, 0], notation: 'a6', voice: "Black plays a6, asking the bishop its intentions." }
  ]},
  french: { name: "French Defense", description: "Solid counter-attack", playerColor: 'black', moves: [
    { from: [6, 4], to: [4, 4], notation: 'e4', voice: "White opens with e4." },
    { from: [1, 4], to: [2, 4], notation: 'e6', voice: "e6, the French Defense. We prepare to challenge with d5." },
    { from: [6, 3], to: [4, 3], notation: 'd4', voice: "White takes the center." },
    { from: [1, 3], to: [3, 3], notation: 'd5', voice: "Now d5! We strike at White's center." },
    { from: [4, 4], to: [3, 4], notation: 'e5', voice: "White advances, gaining space." },
    { from: [1, 2], to: [2, 2], notation: 'c5', voice: "c5 attacks White's pawn chain from the base." }
  ]},
  caroKann: { name: "Caro-Kann Defense", description: "Solid and sound", playerColor: 'black', moves: [
    { from: [6, 4], to: [4, 4], notation: 'e4', voice: "White plays e4." },
    { from: [1, 2], to: [2, 2], notation: 'c6', voice: "c6, the Caro-Kann. We prepare d5 with pawn support." },
    { from: [6, 3], to: [4, 3], notation: 'd4', voice: "White takes the center." },
    { from: [1, 3], to: [3, 3], notation: 'd5', voice: "d5, challenging immediately with full support." },
    { from: [7, 1], to: [5, 2], notation: 'Nc3', voice: "White defends e4." },
    { from: [3, 3], to: [4, 4], notation: 'dxe4', voice: "We capture, leading to clear positions." }
  ]},
  kingsIndian: { name: "King's Indian Defense", description: "Hypermodern counter-attack", playerColor: 'black', moves: [
    { from: [6, 3], to: [4, 3], notation: 'd4', voice: "White opens with d4." },
    { from: [0, 6], to: [2, 5], notation: 'Nf6', voice: "Nf6, letting White build the center first." },
    { from: [6, 2], to: [4, 2], notation: 'c4', voice: "White expands." },
    { from: [1, 6], to: [2, 6], notation: 'g6', voice: "g6 prepares to fianchetto the bishop." },
    { from: [7, 1], to: [5, 2], notation: 'Nc3', voice: "White develops." },
    { from: [0, 5], to: [2, 7], notation: 'Bg7', voice: "The bishop takes the long diagonal. Very powerful!" }
  ]},
  scotch: { name: "Scotch Game", description: "Open and tactical", playerColor: 'white', moves: [
    { from: [6, 4], to: [4, 4], notation: 'e4', voice: "e4 to start." },
    { from: [1, 4], to: [3, 4], notation: 'e5', voice: "Black responds e5." },
    { from: [7, 6], to: [5, 5], notation: 'Nf3', voice: "Knight attacks e5." },
    { from: [0, 1], to: [2, 2], notation: 'Nc6', voice: "Black defends." },
    { from: [6, 3], to: [4, 3], notation: 'd4', voice: "d4 immediately! This is the Scotch Game, very direct." },
    { from: [3, 4], to: [4, 3], notation: 'exd4', voice: "Black captures." }
  ]},
  vienna: { name: "Vienna Game", description: "Flexible and surprising", playerColor: 'white', moves: [
    { from: [6, 4], to: [4, 4], notation: 'e4', voice: "e4 opens the game." },
    { from: [1, 4], to: [3, 4], notation: 'e5', voice: "Black plays e5." },
    { from: [7, 1], to: [5, 2], notation: 'Nc3', voice: "Nc3, the Vienna Game! Different from Nf3." },
    { from: [0, 6], to: [2, 5], notation: 'Nf6', voice: "Black develops." },
    { from: [7, 5], to: [4, 2], notation: 'Bc4', voice: "Bishop to c4, eyeing f7." },
    { from: [0, 5], to: [3, 2], notation: 'Bc5', voice: "Black matches our development." }
  ]},
  pirc: { name: "Pirc Defense", description: "Modern and flexible", playerColor: 'black', moves: [
    { from: [6, 4], to: [4, 4], notation: 'e4', voice: "White plays e4." },
    { from: [1, 3], to: [2, 3], notation: 'd6', voice: "d6, the Pirc Defense. A modern approach." },
    { from: [6, 3], to: [4, 3], notation: 'd4', voice: "White takes the full center." },
    { from: [0, 6], to: [2, 5], notation: 'Nf6', voice: "Nf6 pressures e4." },
    { from: [7, 1], to: [5, 2], notation: 'Nc3', voice: "White defends." },
    { from: [1, 6], to: [2, 6], notation: 'g6', voice: "We fianchetto, preparing to strike back later." }
  ]},
  englund: { name: "Englund Gambit", description: "Aggressive pawn sacrifice", playerColor: 'black', moves: [
    { from: [6, 3], to: [4, 3], notation: 'd4', voice: "White plays d4." },
    { from: [1, 4], to: [3, 4], notation: 'e5', voice: "e5, the Englund Gambit! We sacrifice a pawn for activity." },
    { from: [4, 3], to: [3, 4], notation: 'dxe5', voice: "White accepts." },
    { from: [0, 1], to: [2, 2], notation: 'Nc6', voice: "We develop with tempo on the pawn." },
    { from: [0, 6], to: [2, 5], notation: 'Nf3', voice: "White defends." },
    { from: [0, 3], to: [4, 7], notation: 'Qe7', voice: "Queen eyes the pawn, keeping pressure." }
  ]}
};

// Chess Stories - Historical games with narrative
const CHESS_STORIES = {
  immortal: {
    name: "The Immortal Game",
    year: "1851",
    players: "Anderssen vs Kieseritzky",
    description: "The most famous game in chess history. Anderssen sacrifices both rooks and his queen to deliver a stunning checkmate.",
    intro: "London, 1851. Adolf Anderssen faces Lionel Kieseritzky in what would become the most celebrated chess game ever played...",
    difficulty: 'intermediate',
    moves: [
      { from: [6, 4], to: [4, 4], notation: 'e4', story: "Anderssen opens with the king's pawn, a classical beginning." },
      { from: [1, 4], to: [3, 4], notation: 'e5', story: "Kieseritzky responds in kind." },
      { from: [6, 5], to: [4, 5], notation: 'f4', story: "The King's Gambit! Anderssen offers a pawn for rapid development." },
      { from: [3, 4], to: [4, 5], notation: 'exf4', story: "The gambit is accepted." },
      { from: [7, 5], to: [4, 2], notation: 'Bc4', story: "Anderssen develops with threat, eyeing the weak f7 square." },
      { from: [0, 3], to: [4, 7], notation: 'Qh4+', story: "A bold check! But is it wise?" },
      { from: [7, 4], to: [7, 5], notation: 'Kf1', story: "The king steps aside, but now cannot castle." },
      { from: [1, 1], to: [3, 1], notation: 'b5', story: "Kieseritzky counterattacks the bishop." },
      { from: [4, 2], to: [3, 1], notation: 'Bxb5', story: "Anderssen captures, accepting the challenge." },
      { from: [0, 6], to: [2, 5], notation: 'Nf6', story: "Black develops with tempo." },
      { from: [7, 6], to: [5, 5], notation: 'Nf3', story: "White kicks away the queen." },
    ]
  },
  opera: {
    name: "The Opera Game",
    year: "1858",
    players: "Morphy vs Duke/Count",
    description: "Paul Morphy defeats two amateurs at the opera while barely looking at the board.",
    intro: "Paris Opera House, 1858. Paul Morphy, bored during a performance of The Barber of Seville, agrees to play against the Duke of Brunswick and Count Isouard...",
    difficulty: 'beginner',
    moves: [
      { from: [6, 4], to: [4, 4], notation: 'e4', story: "Morphy opens classically, his eyes still on the stage." },
      { from: [1, 4], to: [3, 4], notation: 'e5', story: "The allies respond." },
      { from: [7, 6], to: [5, 5], notation: 'Nf3', story: "Knight out, attacking the pawn." },
      { from: [1, 3], to: [2, 3], notation: 'd6', story: "A passive defense, Philidor's style." },
      { from: [6, 3], to: [4, 3], notation: 'd4', story: "Morphy strikes at the center!" },
      { from: [0, 2], to: [6, 6], notation: 'Bg4', story: "Pinning the knight to the queen." },
      { from: [4, 3], to: [3, 4], notation: 'dxe5', story: "Morphy ignores the pin and captures!" },
      { from: [6, 6], to: [5, 5], notation: 'Bxf3', story: "Black takes the knight." },
      { from: [7, 3], to: [5, 5], notation: 'Qxf3', story: "Queen recaptures with a powerful position." },
    ]
  },
  evergreen: {
    name: "The Evergreen Game",
    year: "1852",
    players: "Anderssen vs Dufresne",
    description: "Another Anderssen masterpiece with spectacular sacrifices leading to a beautiful finale.",
    intro: "Berlin, 1852. Anderssen faces Jean Dufresne in a game that would echo through eternity...",
    difficulty: 'advanced',
    moves: [
      { from: [6, 4], to: [4, 4], notation: 'e4', story: "e4, the king's pawn opens the battle." },
      { from: [1, 4], to: [3, 4], notation: 'e5', story: "Dufresne mirrors the move." },
      { from: [7, 6], to: [5, 5], notation: 'Nf3', story: "The knight develops to its natural square." },
      { from: [0, 1], to: [2, 2], notation: 'Nc6', story: "Black defends the pawn." },
      { from: [7, 5], to: [4, 2], notation: 'Bc4', story: "Italian Game - targeting f7." },
      { from: [0, 5], to: [4, 1], notation: 'Bc5', story: "Black mirrors with equal development." },
      { from: [6, 1], to: [4, 1], notation: 'b4', story: "The Evans Gambit! A pawn sacrifice for tempo." },
      { from: [4, 1], to: [3, 2], notation: 'Bxb4', story: "Black accepts the gambit." },
    ]
  },
  gameOfCentury: {
    name: "Game of the Century",
    year: "1956",
    players: "D. Byrne vs Fischer",
    description: "13-year-old Bobby Fischer stuns the chess world with a queen sacrifice for the ages.",
    intro: "New York, 1956. A 13-year-old prodigy named Bobby Fischer sits across from Donald Byrne, one of America's top players...",
    difficulty: 'advanced',
    moves: [
      { from: [7, 6], to: [5, 5], notation: 'Nf3', story: "Byrne opens with the knight." },
      { from: [0, 6], to: [2, 5], notation: 'Nf6', story: "Young Fischer responds symmetrically." },
      { from: [6, 2], to: [4, 2], notation: 'c4', story: "The English Opening takes shape." },
      { from: [1, 6], to: [2, 6], notation: 'g6', story: "Fischer prepares the King's Indian setup." },
      { from: [7, 1], to: [5, 2], notation: 'Nc3', story: "White develops naturally." },
      { from: [0, 5], to: [1, 6], notation: 'Bg7', story: "The fianchetto is complete." },
      { from: [6, 3], to: [4, 3], notation: 'd4', story: "White claims the center." },
      { from: [1, 3], to: [2, 3], notation: 'd6', story: "Fischer plays solidly." },
    ]
  },
  deepBlue: {
    name: "Kasparov vs Deep Blue",
    year: "1997",
    players: "Kasparov vs Deep Blue",
    description: "The historic moment when a computer defeated the world champion for the first time.",
    intro: "New York, 1997. Garry Kasparov, the greatest player alive, faces IBM's Deep Blue in a battle for humanity's pride...",
    difficulty: 'intermediate',
    moves: [
      { from: [6, 4], to: [4, 4], notation: 'e4', story: "Deep Blue opens with e4." },
      { from: [1, 2], to: [2, 2], notation: 'c6', story: "Kasparov chooses the Caro-Kann, a solid defense." },
      { from: [6, 3], to: [4, 3], notation: 'd4', story: "The machine builds a classical center." },
      { from: [1, 3], to: [3, 3], notation: 'd5', story: "Kasparov challenges the center immediately." },
      { from: [7, 1], to: [5, 2], notation: 'Nc3', story: "White defends the e4 pawn." },
      { from: [3, 3], to: [4, 4], notation: 'dxe4', story: "Kasparov captures, entering main lines." },
      { from: [5, 2], to: [4, 4], notation: 'Nxe4', story: "The knight recaptures centrally." },
    ]
  },
  zugzwang: {
    name: "The Immortal Zugzwang",
    year: "1923",
    players: "Samisch vs Nimzowitsch",
    description: "Nimzowitsch demonstrates the power of zugzwang - where any move loses.",
    intro: "Copenhagen, 1923. Aron Nimzowitsch, the hypermodern revolutionary, faces Friedrich Samisch in a positional masterpiece...",
    difficulty: 'advanced',
    moves: [
      { from: [6, 2], to: [4, 2], notation: 'c4', story: "Samisch opens with the English." },
      { from: [0, 6], to: [2, 5], notation: 'Nf6', story: "Nimzowitsch develops flexibly." },
      { from: [7, 1], to: [5, 2], notation: 'Nc3', story: "White builds on the queenside." },
      { from: [1, 4], to: [2, 4], notation: 'e6', story: "Black prepares a solid structure." },
      { from: [6, 3], to: [4, 3], notation: 'd4', story: "White claims central space." },
      { from: [0, 5], to: [3, 2], notation: 'Bb4', story: "The Nimzo-Indian Defense! Named after Nimzowitsch himself." },
    ]
  }
};

// Today in Chess History - 31 entries (one for each day of month)
// === DAILY DASHBOARD DATA ===

// Today in Chess History - 31 entries
const CHESS_HISTORY = [
  { day: 1, title: "Fischer Becomes Youngest US Champion", year: 1958, content: "On this day, 14-year-old Bobby Fischer won the US Championship, becoming the youngest champion in history." },
  { day: 2, title: "Birth of Tigran Petrosian", year: 1929, content: "World Champion Tigran Petrosian was born. Known as Iron Tigran for his impenetrable defensive style." },
  { day: 3, title: "First Chess Computer Beats Master", year: 1988, content: "Deep Thought became the first computer to defeat a grandmaster in tournament play." },
  { day: 4, title: "Capablanca's Perfect Tournament", year: 1911, content: "Jose Raul Capablanca completed a perfect tournament at San Sebastian without a single loss." },
  { day: 5, title: "Birth of Anatoly Karpov", year: 1951, content: "Anatoly Karpov was born. He would become World Champion in 1975 and defend his title for 10 years." },
  { day: 6, title: "The Longest WC Match", year: 1984, content: "The marathon Karpov-Kasparov match was stopped after 48 games with no winner." },
  { day: 7, title: "First Woman Grandmaster", year: 1978, content: "Nona Gaprindashvili became the first woman awarded the Grandmaster title." },
  { day: 8, title: "Birth of Capablanca", year: 1888, content: "The legendary Cuban World Champion was born. He learned chess at age 4 by watching his father." },
  { day: 9, title: "Deep Blue Wins Game 1", year: 1996, content: "IBM's Deep Blue became the first computer to win against a reigning World Champion." },
  { day: 10, title: "Birth of Boris Spassky", year: 1937, content: "Boris Spassky was born. He would become World Champion in 1969." },
  { day: 11, title: "FIDE is Founded", year: 1924, content: "The World Chess Federation was founded in Paris." },
  { day: 12, title: "Kasparov Beats Deep Blue", year: 1996, content: "After losing game 1, Kasparov rallied to defeat Deep Blue 4-2." },
  { day: 13, title: "Magnus Carlsen Born", year: 1990, content: "Magnus Carlsen was born in Norway. He would become the highest-rated player in history." },
  { day: 14, title: "The Immortal Game", year: 1851, content: "Anderssen played the Immortal Game, sacrificing both rooks and his queen." },
  { day: 15, title: "Birth of Mikhail Tal", year: 1936, content: "The Magician from Riga was born. Known for dazzling sacrifices." },
  { day: 16, title: "First World Championship", year: 1886, content: "Wilhelm Steinitz became the first official World Chess Champion." },
  { day: 17, title: "Birth of Viswanathan Anand", year: 1969, content: "India's first World Champion was born." },
  { day: 18, title: "Fischer Forfeits Game 2", year: 1972, content: "Bobby Fischer forfeited due to complaints about cameras." },
  { day: 19, title: "Birth of Alekhine", year: 1892, content: "Alexander Alekhine was born. He became World Champion in 1927." },
  { day: 20, title: "Youngest World Champion", year: 1985, content: "At 22, Garry Kasparov became the youngest World Chess Champion." },
  { day: 21, title: "Deep Blue Wins Rematch", year: 1997, content: "Deep Blue defeated Kasparov, the first computer to beat a World Champion in a match." },
  { day: 22, title: "Birth of Emanuel Lasker", year: 1868, content: "Emanuel Lasker held the title for 27 years, the longest reign ever." },
  { day: 23, title: "Fischer's Perfect 11-0", year: 1963, content: "Bobby Fischer achieved a perfect score in the US Championship." },
  { day: 24, title: "Birth of Nakamura", year: 1987, content: "Hikaru Nakamura was born. He became the youngest American GM at 15." },
  { day: 25, title: "The Opera Game", year: 1858, content: "Paul Morphy played his famous Opera Game in Paris." },
  { day: 26, title: "Birth of Judit Polgar", year: 1976, content: "The strongest female player in history was born." },
  { day: 27, title: "Fischer Defeats Taimanov 6-0", year: 1971, content: "Bobby Fischer demolished Taimanov in the Candidates match." },
  { day: 28, title: "Birth of Kramnik", year: 1975, content: "Vladimir Kramnik was born. He defeated Kasparov in 2000." },
  { day: 29, title: "First Chess Olympiad", year: 1924, content: "The first Chess Olympiad was held in Paris with 16 nations." },
  { day: 30, title: "Kasparov Retires", year: 2005, content: "Garry Kasparov retired from professional chess." },
  { day: 31, title: "Birth of Paul Morphy", year: 1837, content: "Paul Morphy, the pride of American chess, was born." },
];

// Piece of the Day - 7 pieces (one per day of week)
const PIECE_OF_DAY = [
  { piece: "King", symbol: "‚ôî", value: "Infinite", strengths: "The game revolves around protecting him. In endgames, he becomes a fighting piece.", weaknesses: "Vulnerable to checks and must be protected early.", tips: "Castle early. In endgames, centralize your king - he can control 8 squares!", famousMove: "In the Immortal Game, Anderssen's king walked to f1, giving up castling rights but leading to victory." },
  { piece: "Queen", symbol: "‚ôï", value: "9 points", strengths: "Most powerful piece. Combines rook and bishop movement. Controls up to 27 squares.", weaknesses: "High value makes her a target. Don't develop too early.", tips: "Don't bring her out too early. She's best when supporting other pieces in attacks.", famousMove: "In the Opera Game, Morphy sacrificed his queen with Qb8+!! leading to a stunning mate." },
  { piece: "Rook", symbol: "‚ôñ", value: "5 points", strengths: "Powerful on open files and ranks. Two rooks work brilliantly together.", weaknesses: "Needs open lines. Often trapped in corners early game.", tips: "Connect your rooks by castling. Put them on open files and the 7th rank.", famousMove: "Anderssen sacrificed BOTH rooks in the Immortal Game, yet still won brilliantly." },
  { piece: "Bishop", symbol: "‚ôó", value: "3 points", strengths: "Long-range diagonal control. Bishop pair is very powerful in open positions.", weaknesses: "Can only cover half the squares. Bad when blocked by own pawns.", tips: "Keep your pawns off the same color as your bishop. Two bishops dominate in open games.", famousMove: "The Greek Gift sacrifice Bxh7+ has won countless games throughout history." },
  { piece: "Knight", symbol: "‚ôò", value: "3 points", strengths: "Only piece that can jump. Excellent in closed positions. Forks are deadly.", weaknesses: "Slow - needs many moves to cross the board. Bad on the rim.", tips: "Knights on the rim are dim! Centralize them. Look for outpost squares.", famousMove: "In the Game of the Century, Fischer's knight dance Ne4-d5 led to a queen sacrifice." },
  { piece: "Pawn", symbol: "‚ôô", value: "1 point", strengths: "Can promote to any piece. Pawn structure defines the game. Passed pawns are powerful.", weaknesses: "Cannot move backward. Doubled and isolated pawns are weak.", tips: "Pawns are the soul of chess. Every pawn move creates permanent weaknesses.", famousMove: "Philidor said: The pawns are the soul of chess. A pawn on the 7th rank is worth a piece!" },
  { piece: "The Board", symbol: "‚ôü", value: "64 squares", strengths: "Control the center (d4, d5, e4, e5). These squares give your pieces maximum reach.", weaknesses: "Edges limit piece mobility. Corners are often dead ends.", tips: "Think of the board in zones: center is premium real estate, flanks support the center.", famousMove: "Nimzowitsch revolutionized chess by showing you can control the center without occupying it." },
];

// Opening Spotlight - 7 openings (one per day of week)
const OPENING_SPOTLIGHT = [
  { name: "Italian Game", moves: "1.e4 e5 2.Nf3 Nc6 3.Bc4", idea: "Rapid development targeting f7, the weakest square.", keyIdeas: ["Develop bishops before knights to c4 and c5", "Control the center with d3 or d4", "Castle kingside quickly"], bestFor: "Attacking players who like clear plans" },
  { name: "Sicilian Defense", moves: "1.e4 c5", idea: "Black fights for the center asymmetrically, leading to sharp play.", keyIdeas: ["Black gets a semi-open c-file", "White often attacks kingside, Black on queenside", "Very theory-heavy but rewarding"], bestFor: "Players who want winning chances as Black" },
  { name: "Queen's Gambit", moves: "1.d4 d5 2.c4", idea: "White offers a pawn to control the center. Not a true gambit!", keyIdeas: ["If dxc4, White gets a strong center with e4", "Black can decline with e6 (solid) or c6 (Slav)", "Leads to strategic battles"], bestFor: "Positional players who like long-term plans" },
  { name: "King's Indian", moves: "1.d4 Nf6 2.c4 g6", idea: "Black lets White build a center, then attacks it.", keyIdeas: ["Fianchetto the bishop to g7", "Break with e5 or c5", "Complex middlegames with opposite-side attacks"], bestFor: "Dynamic players who enjoy counterattacking" },
  { name: "Ruy Lopez", moves: "1.e4 e5 2.Nf3 Nc6 3.Bb5", idea: "The Spanish torture - slow pressure on Black's position.", keyIdeas: ["The bishop eyes the knight defending e5", "White builds slowly with c3, d4, Nbd2", "Deep theory but clear strategic ideas"], bestFor: "Patient players who like slow squeezes" },
  { name: "London System", moves: "1.d4 d5 2.Bf4", idea: "Solid, easy to learn, hard to refute. A system, not a variation.", keyIdeas: ["Always develop bishop to f4 before e3", "Build a pyramid: d4-e3-c3", "Castle, then play for e4 or queenside expansion"], bestFor: "Beginners and those who dislike heavy theory" },
  { name: "Caro-Kann", moves: "1.e4 c6", idea: "Solid defense supporting d5 without blocking the c8 bishop.", keyIdeas: ["After d5, the c8 bishop is free", "Leads to slightly passive but solid positions", "Exchange variation is simplest, Advance is sharpest"], bestFor: "Solid players who want reliable positions as Black" },
];

// Chess Legends - 31 profiles
const CHESS_LEGENDS = [
  { name: "Garry Kasparov", years: "1963-", title: "13th World Champion", style: "Aggressive, Dynamic", peak: "2851", achievement: "Dominated chess for 20 years. Youngest World Champion at 22.", quote: "Chess is mental torture." },
  { name: "Bobby Fischer", years: "1943-2008", title: "11th World Champion", style: "Universal, Precise", peak: "2785", achievement: "Single-handedly defeated the Soviet chess machine in 1972.", quote: "I don't believe in psychology. I believe in good moves." },
  { name: "Magnus Carlsen", years: "1990-", title: "16th World Champion", style: "Universal, Endgame Master", peak: "2882", achievement: "Highest-rated player in history. Dominated 2010s-2020s.", quote: "I'm not afraid of anyone." },
  { name: "Jose Raul Capablanca", years: "1888-1942", title: "3rd World Champion", style: "Natural, Effortless", peak: "~2725", achievement: "Went 8 years without losing a game. Chess came naturally to him.", quote: "A good player is always lucky." },
  { name: "Mikhail Tal", years: "1936-1992", title: "8th World Champion", style: "Attacking, Sacrificial", peak: "2705", achievement: "The Magician from Riga. Made impossible sacrifices work.", quote: "You must take your opponent into a deep dark forest." },
  { name: "Anatoly Karpov", years: "1951-", title: "12th World Champion", style: "Positional, Prophylactic", peak: "2780", achievement: "Master of small advantages. Won by slow strangulation.", quote: "Chess is everything: art, science, and sport." },
  { name: "Emanuel Lasker", years: "1868-1941", title: "2nd World Champion", style: "Psychological, Practical", peak: "~2720", achievement: "Held the title for 27 years - longest reign ever.", quote: "When you see a good move, look for a better one." },
  { name: "Viswanathan Anand", years: "1969-", title: "15th World Champion", style: "Fast, Intuitive", peak: "2817", achievement: "India's first World Champion. Known for lightning speed.", quote: "I try to make my style more and more like water." },
  { name: "Vladimir Kramnik", years: "1975-", title: "14th World Champion", style: "Solid, Deep", peak: "2817", achievement: "Defeated Kasparov without losing a game in 2000.", quote: "I am convinced, the way one plays chess always reflects the player's personality." },
  { name: "Paul Morphy", years: "1837-1884", title: "Unofficial World Champion", style: "Brilliant, Romantic", peak: "~2690", achievement: "Dominated the 1850s. Retired at 22 after crushing all opponents.", quote: "Help your pieces so they can help you." },
  { name: "Alexander Alekhine", years: "1892-1946", title: "4th World Champion", style: "Aggressive, Complex", peak: "~2690", achievement: "Known for incredibly deep combinations and attacking chess.", quote: "Chess for me is not a game, but an art." },
  { name: "Judit Polgar", years: "1976-", title: "Strongest Woman Ever", style: "Aggressive, Tactical", peak: "2735", achievement: "Became GM at 15, beat nearly every World Champion.", quote: "I always say women should have more self-confidence." },
  { name: "Hikaru Nakamura", years: "1987-", title: "5x US Champion", style: "Tactical, Fast", peak: "2816", achievement: "Youngest American GM. World #1 in rapid and blitz.", quote: "I just try to play good moves." },
  { name: "Fabiano Caruana", years: "1992-", title: "World #2", style: "Universal, Prepared", peak: "2844", achievement: "Came within one game of becoming World Champion in 2018.", quote: "Preparation is key in modern chess." },
  { name: "Tigran Petrosian", years: "1929-1984", title: "9th World Champion", style: "Defensive, Prophylactic", peak: "2690", achievement: "Iron Tigran - nearly impossible to beat.", quote: "Some sacrifices are sound, the rest are mine." },
  { name: "Boris Spassky", years: "1937-", title: "10th World Champion", style: "Universal, Elegant", peak: "2690", achievement: "Lost the Match of the Century to Fischer but remained graceful.", quote: "The best indicator of a chess player's form is his ability to sense the climax of the game." },
  { name: "Mikhail Botvinnik", years: "1911-1995", title: "6th World Champion", style: "Scientific, Prepared", peak: "2690", achievement: "Patriarch of Soviet chess. Trained Karpov, Kasparov, Kramnik.", quote: "Chess is the art of analysis." },
  { name: "Vassily Smyslov", years: "1921-2010", title: "7th World Champion", style: "Harmonious, Positional", peak: "2620", achievement: "Known for beautiful endgame play and artistic style.", quote: "Chess is like music." },
  { name: "Wilhelm Steinitz", years: "1836-1900", title: "1st World Champion", style: "Scientific, Defensive", peak: "~2630", achievement: "Father of positional chess. Revolutionized how we think about the game.", quote: "Chess is not for the faint-hearted." },
  { name: "Ding Liren", years: "1992-", title: "17th World Champion", style: "Solid, Resourceful", peak: "2816", achievement: "First Chinese World Champion. Won dramatic 2023 title match.", quote: "I just want to play good chess." },
  { name: "Levon Aronian", years: "1982-", title: "World #2", style: "Creative, Dynamic", peak: "2830", achievement: "One of the most creative players of his generation.", quote: "I love beautiful games." },
  { name: "Wesley So", years: "1993-", title: "US Champion, Fischer Random WC", style: "Solid, Precise", peak: "2822", achievement: "Known for incredible consistency and defensive skills.", quote: "I try to make as few mistakes as possible." },
  { name: "Ian Nepomniachtchi", years: "1990-", title: "Challenger", style: "Fast, Intuitive", peak: "2795", achievement: "Twice challenged for the World Championship.", quote: "I play what I see on the board." },
  { name: "Maxime Vachier-Lagrave", years: "1990-", title: "French #1", style: "Sharp, Theoretical", peak: "2819", achievement: "Known for incredible depth in the Najdorf Sicilian.", quote: "Opening preparation is crucial at the top level." },
  { name: "Sergey Karjakin", years: "1990-", title: "Youngest GM Ever", style: "Solid, Tenacious", peak: "2788", achievement: "Became GM at 12 years, 7 months. Challenged for World title.", quote: "Defense is also an art." },
  { name: "Veselin Topalov", years: "1975-", title: "FIDE World Champion", style: "Aggressive, Risk-taking", peak: "2816", achievement: "Known for incredibly sharp, computer-like play.", quote: "I prefer to attack than defend." },
  { name: "Shakhriyar Mamedyarov", years: "1985-", title: "World #2", style: "Aggressive, Creative", peak: "2820", achievement: "Known for spectacular attacking games.", quote: "I play for the win in every game." },
  { name: "Teimour Radjabov", years: "1987-", title: "World Cup Winner", style: "Solid, Deep", peak: "2793", achievement: "Giant killer - defeated Kasparov at 15 years old.", quote: "Chess is my life." },
  { name: "Peter Svidler", years: "1976-", title: "8x Russian Champion", style: "Universal, Deep", peak: "2765", achievement: "One of the greatest players never to play a World Championship match.", quote: "I try to enjoy every game." },
  { name: "Vassily Ivanchuk", years: "1969-", title: "Genius", style: "Creative, Unpredictable", peak: "2787", achievement: "Called a genius by Kasparov. Known for incredible creativity.", quote: "Chess is life in miniature." },
  { name: "Alireza Firouzja", years: "2003-", title: "Prodigy", style: "Dynamic, Fearless", peak: "2804", achievement: "Youngest ever to reach 2800. Future World Champion candidate.", quote: "I just want to play chess." },
];

// Tactical Patterns - 7 patterns (one per day of week)
const TACTICAL_PATTERNS = [
  { name: "The Fork", symbol: "‚öî", description: "One piece attacks two or more enemy pieces simultaneously.", howTo: "Knights are fork masters! Queens can fork too. Look for undefended pieces on the same rank, file, or diagonal.", example: "A knight on e4 can fork a king on d6 and queen on f2.", defense: "Keep your valuable pieces away from knight-hopping distance. Watch for tactical shots.", difficulty: "Beginner" },
  { name: "The Pin", symbol: "üìå", description: "A piece cannot move because it would expose a more valuable piece behind it.", howTo: "Bishops and rooks are pinning pieces. Look for pieces in a line with the king or queen.", example: "A bishop on b5 pins a knight on c6 to the king on e8 - the knight cannot move!", defense: "Break the pin by blocking, moving the king, or eliminating the pinning piece.", difficulty: "Beginner" },
  { name: "The Skewer", symbol: "üó°", description: "Like a reverse pin - attack a valuable piece that must move, exposing a piece behind it.", howTo: "The attacked piece MUST move (usually a king in check), leaving the piece behind to be captured.", example: "A rook checks a king, and when the king moves, captures the queen behind it.", defense: "Avoid placing valuable pieces in a line. Interpose when possible.", difficulty: "Intermediate" },
  { name: "Discovered Attack", symbol: "üí•", description: "Moving one piece reveals an attack by another piece behind it.", howTo: "The moving piece can deliver its own threat while uncovering another. Double attacks are devastating!", example: "A knight moves to give check while revealing a bishop attack on the queen.", defense: "Watch for pieces that can move with tempo. Dont let pieces align dangerously.", difficulty: "Intermediate" },
  { name: "Double Check", symbol: "‚ö°", description: "Two pieces give check simultaneously. The king MUST move - no blocking possible!", howTo: "Only possible through discovered attack where the moving piece also gives check.", example: "A knight moves to deliver check while uncovering a bishop that also gives check.", defense: "Extremely hard to defend. Prevention is key - dont let pieces align on your king.", difficulty: "Advanced" },
  { name: "Back Rank Mate", symbol: "üèÅ", description: "Checkmate on the back rank when pawns trap the king.", howTo: "Look for an undefended back rank. A rook or queen can deliver the final blow.", example: "With pawns on f2, g2, h2 and king on g1, a rook on e1 delivers Re1-e8 mate!", defense: "Create luft (breathing room) with h3 or g3. Keep a rook on the back rank.", difficulty: "Beginner" },
  { name: "Deflection", symbol: "üéØ", description: "Force a defending piece away from its protective duty.", howTo: "Sacrifice or attack a piece so the defender must leave its post.", example: "If a knight defends a mate threat, sacrifice your queen for it to remove the defender.", defense: "Be aware when a piece has multiple defensive duties. Add more defenders.", difficulty: "Advanced" },
];

// Chess Wisdom - 31 deep quotes with context
const CHESS_WISDOM = [
  { quote: "Every chess master was once a beginner.", author: "Irving Chernev", context: "Reminder that greatness comes from persistence. Even Kasparov lost his first games. Focus on improvement, not perfection." },
  { quote: "When you see a good move, look for a better one.", author: "Emanuel Lasker", context: "The sign of a strong player. Never rush. That brilliant move might have an even more brilliant sibling." },
  { quote: "The pawns are the soul of chess.", author: "Philidor", context: "Pawn structure determines everything: where pieces belong, which side to attack, who has the advantage. Respect your pawns." },
  { quote: "Chess is 99% tactics.", author: "Richard Teichmann", context: "While strategy sets the direction, tactics win games. Study combinations daily - they are the foundation of chess strength." },
  { quote: "The threat is stronger than the execution.", author: "Aron Nimzowitsch", context: "A threat forces your opponent to react, limiting their options. Sometimes keeping the threat alive is better than executing it." },
  { quote: "In the opening a master should play like a book, in the mid-game like a magician, and in the endgame like a machine.", author: "Spielmann", context: "Different phases need different approaches: solid theory, creative calculation, and precise technique." },
  { quote: "A bad plan is better than no plan at all.", author: "Frank Marshall", context: "Even flawed direction beats aimless moves. Make a plan, follow it, and adjust as needed." },
  { quote: "The winner of the game is the player who makes the next-to-last mistake.", author: "Tartakower", context: "Chess is a game of mistakes. Your job isnt to play perfectly - its to make fewer mistakes than your opponent." },
  { quote: "You cannot play chess if you are kind-hearted.", author: "French Proverb", context: "Ruthlessness at the board is a virtue. When you have the advantage, press it. Show no mercy." },
  { quote: "Half the variations calculated in a game turn out to be completely superfluous.", author: "Kotov", context: "Focus your calculation on critical lines. Not every possibility needs deep analysis - learn to identify key moves." },
  { quote: "Tactics flow from a superior position.", author: "Bobby Fischer", context: "Random tactics rarely work. Build your position first, then the combinations will appear naturally." },
  { quote: "The hardest game to win is a won game.", author: "Emanuel Lasker", context: "When ahead, stay calm and alert. Many games are thrown away by overconfidence. Convert your advantage methodically." },
  { quote: "Endings are the beginning of chess.", author: "Nimzowitsch", context: "Study endgames first. When you understand endings, you know what pieces to trade and what structures to create." },
  { quote: "A knight on f5 is worth a rook.", author: "Chess Proverb", context: "A powerfully placed piece can dominate. Outposts, especially for knights, can be worth more than their material value." },
  { quote: "To improve at chess, you should mainly study the endgame.", author: "Jose Capablanca", context: "From a World Champion who rarely lost. Endgame knowledge gives you confidence throughout the game." },
  { quote: "Chess is the struggle against error.", author: "Johannes Zukertort", context: "You play against yourself as much as your opponent. Minimize your errors and maximize theirs." },
  { quote: "Help your pieces so they can help you.", author: "Paul Morphy", context: "Development and piece coordination win games. A piece doing nothing is worth nothing." },
  { quote: "Even a poor plan is better than no plan at all.", author: "Mikhail Chigorin", context: "Direction matters. Random moves lead nowhere. Pick a plan, even an imperfect one, and pursue it." },
  { quote: "Chess is life in miniature.", author: "Kasparov", context: "The skills chess teaches - planning, consequences, resilience - apply to everything in life." },
  { quote: "You may learn much more from a game you lose than from a game you win.", author: "Jose Capablanca", context: "Losses reveal weaknesses. Study your defeats more carefully than your victories." },
  { quote: "Modern chess is too much concerned with things like pawn structure. Forget it - Loss is what counts.", author: "Tal", context: "Tals reminder that chess is about the king. All the theory in the world means nothing if you miss the mating attack." },
  { quote: "The pin is mightier than the sword.", author: "Fred Reinfeld", context: "A pinned piece is a paralyzed piece. Master the pin and you master a fundamental weapon of chess." },
  { quote: "Chess demands total concentration.", author: "Bobby Fischer", context: "One moment of inattention can undo hours of good play. Stay focused until the final move." },
  { quote: "Place the contents of your opponents head inside your own.", author: "Alexander Kotov", context: "Think from your opponents perspective. Understanding their plans helps you counter them." },
  { quote: "Openings teach you openings. Endgames teach you chess.", author: "Stephan Gerzadowicz", context: "Opening theory changes. Endgame principles are eternal. Invest your study time wisely." },
  { quote: "The essence of chess is thinking about what chess is.", author: "David Bronstein", context: "Understanding WHY moves work matters more than memorizing WHAT moves to play." },
  { quote: "I used to attack because it was the only thing I knew.", author: "Bobby Fischer", context: "Even Fischer evolved. Attack is powerful, but understanding defense makes your attack even stronger." },
  { quote: "In blitz, the weights of character are tested.", author: "Unknown", context: "Fast chess reveals true instincts. How you play under pressure shows your real understanding." },
  { quote: "Chess is above all a fight.", author: "Emanuel Lasker", context: "Never play passively. Every move should fight for something - space, pieces, initiative, or the win." },
  { quote: "Methodical thinking is of more use in chess than inspiration.", author: "Purdy", context: "Brilliance is overrated. Consistent, logical thinking beats occasional flashes of genius." },
  { quote: "The beauty of a move lies not in its appearance but in the thought behind it.", author: "Aron Nimzowitsch", context: "Understanding why a move works makes it beautiful. Chess is about ideas, not just moves." },
];

function getDailyContent() {
  const today = new Date();
  const dayOfMonth = today.getDate();
  const dayOfWeek = today.getDay();
  
  return {
    history: CHESS_HISTORY[(dayOfMonth - 1) % CHESS_HISTORY.length],
    piece: PIECE_OF_DAY[dayOfWeek],
    opening: OPENING_SPOTLIGHT[dayOfWeek],
    legend: CHESS_LEGENDS[(dayOfMonth - 1) % CHESS_LEGENDS.length],
    tactic: TACTICAL_PATTERNS[dayOfWeek],
    wisdom: CHESS_WISDOM[(dayOfMonth - 1) % CHESS_WISDOM.length],
  };
}

function getTodaysArticle() {
  const today = new Date();
  const dayOfMonth = today.getDate();
  return CHESS_HISTORY[(dayOfMonth - 1) % CHESS_HISTORY.length];
}

// Daily Puzzles - Mate in 1, 2, or 3
const DAILY_PUZZLES = [
  {
    id: 'puzzle_1',
    name: "Back Rank Mate",
    type: 'mate_in_1',
    difficulty: 'beginner',
    board: [
      [null, null, null, null, null, 'r', 'k', null],
      ['p', 'p', 'p', null, null, 'p', 'p', 'p'],
      [null, null, null, null, null, null, null, null],
      [null, null, null, null, null, null, null, null],
      [null, null, null, null, null, null, null, null],
      [null, null, null, null, null, null, null, null],
      ['P', 'P', 'P', null, null, 'P', 'P', 'P'],
      [null, null, null, null, 'R', null, 'K', null]
    ],
    solution: { from: [7, 4], to: [0, 4] },
    hint: "The king is trapped on the back rank...",
    explanation: "Re8 is checkmate! The king cannot escape because his own pawns trap him."
  },
  {
    id: 'puzzle_2',
    name: "Queen Fork",
    type: 'win_material',
    difficulty: 'beginner',
    board: [
      ['r', null, null, null, 'k', null, null, 'r'],
      ['p', 'p', null, null, null, 'p', 'p', 'p'],
      [null, null, null, null, null, null, null, null],
      [null, null, null, null, null, null, null, null],
      [null, null, null, null, null, null, null, null],
      [null, null, 'Q', null, null, null, null, null],
      ['P', 'P', 'P', null, null, 'P', 'P', 'P'],
      ['R', null, null, null, 'K', null, null, 'R']
    ],
    solution: { from: [5, 2], to: [2, 5] },
    hint: "Can you attack two pieces at once?",
    explanation: "Qf6 forks the king and the rook on h8!"
  },
  {
    id: 'puzzle_3',
    name: "Smothered Mate",
    type: 'mate_in_2',
    difficulty: 'intermediate',
    board: [
      [null, null, null, null, null, 'r', 'k', null],
      [null, null, null, null, null, 'p', 'p', 'p'],
      [null, null, null, null, null, null, null, null],
      [null, null, null, null, null, null, 'Q', null],
      [null, null, null, null, null, 'N', null, null],
      [null, null, null, null, null, null, null, null],
      [null, null, null, null, null, null, null, null],
      [null, null, null, null, null, null, 'K', null]
    ],
    solution: { from: [4, 5], to: [2, 6] },
    hint: "The knight can be devastating in close quarters...",
    explanation: "Ng6+ forces the king to h8, then Qg8+ Rxg8, Nf7#!"
  },
  {
    id: 'puzzle_4',
    name: "Pin and Win",
    type: 'win_material',
    difficulty: 'beginner',
    board: [
      ['r', null, 'b', null, 'k', null, null, 'r'],
      ['p', 'p', 'p', null, null, 'p', 'p', 'p'],
      [null, null, null, null, null, null, null, null],
      [null, null, null, 'q', null, null, null, null],
      [null, null, null, null, null, null, null, null],
      [null, null, null, null, null, null, null, null],
      ['P', 'P', 'P', null, 'B', 'P', 'P', 'P'],
      ['R', null, null, 'Q', null, null, 'K', null]
    ],
    solution: { from: [6, 4], to: [3, 7] },
    hint: "The queen can't move away if it's protecting the king...",
    explanation: "Bh7 pins the queen to the king. The queen is lost!"
  },
  {
    id: 'puzzle_5',
    name: "Greek Gift",
    type: 'mate_in_3',
    difficulty: 'advanced',
    board: [
      ['r', null, 'b', 'q', null, 'r', 'k', null],
      ['p', 'p', 'p', null, null, 'p', 'p', 'p'],
      [null, null, 'n', 'p', null, 'n', null, null],
      [null, null, null, null, 'p', null, null, null],
      [null, null, 'B', null, 'P', null, null, null],
      [null, null, null, null, null, 'N', null, null],
      ['P', 'P', 'P', null, null, 'P', 'P', 'P'],
      ['R', null, 'B', 'Q', null, 'R', 'K', null]
    ],
    solution: { from: [4, 2], to: [1, 5] },
    hint: "Sometimes sacrifice leads to glory...",
    explanation: "Bxf7+! The classic Greek Gift sacrifice. King takes, then Ng5+ and the attack is overwhelming."
  },
  {
    id: 'puzzle_6',
    name: "Discovered Attack",
    type: 'win_material',
    difficulty: 'intermediate',
    board: [
      ['r', null, null, null, 'k', null, null, 'r'],
      ['p', 'p', 'p', null, null, 'p', 'p', 'p'],
      [null, null, null, null, null, null, null, null],
      [null, null, null, null, null, null, null, null],
      [null, null, null, null, 'B', null, null, null],
      [null, null, null, null, null, 'N', null, null],
      ['P', 'P', 'P', null, null, 'P', 'P', 'P'],
      ['R', null, null, 'Q', null, null, 'K', null]
    ],
    solution: { from: [5, 5], to: [3, 6] },
    hint: "Moving one piece can reveal an attack by another...",
    explanation: "Ng4! The knight moves and discovers an attack by the bishop on the rook!"
  },
  {
    id: 'puzzle_7',
    name: "Ladder Mate",
    type: 'mate_in_2',
    difficulty: 'beginner',
    board: [
      [null, null, null, null, null, null, null, 'k'],
      [null, null, null, null, null, null, null, null],
      [null, null, null, null, null, null, null, null],
      [null, null, null, null, null, null, null, null],
      [null, null, null, null, null, null, null, null],
      [null, null, null, null, null, null, null, null],
      [null, null, null, null, null, null, null, null],
      ['R', 'R', null, null, null, null, 'K', null]
    ],
    solution: { from: [7, 0], to: [0, 0] },
    hint: "Use both rooks to push the king...",
    explanation: "Ra8+ Kg7, Rb7 and the mate follows with the rooks working together."
  }
];

// Get puzzle for today based on date
function getTodaysPuzzle() {
  const dayOfYear = Math.floor((Date.now() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
  return DAILY_PUZZLES[dayOfYear % DAILY_PUZZLES.length];
}

function deepCopyBoard(board) { return board.map(row => [...row]); }

function getBoardAtMove(moves, idx) {
  const b = deepCopyBoard(INITIAL_BOARD);
  for (let i = 0; i < idx; i++) { const m = moves[i]; b[m.to[0]][m.to[1]] = b[m.from[0]][m.from[1]]; b[m.from[0]][m.from[1]] = null; }
  return b;
}

function useSpeech() {
  const [isSpeaking, setIsSpeaking] = useState(false);
  const voiceRef = useRef(null);
  useEffect(() => {
    const load = () => { const v = window.speechSynthesis?.getVoices() || []; for (const n of ['Google UK English Female', 'Google US English', 'Samantha']) { const f = v.find(x => x.name.includes(n)); if (f) { voiceRef.current = f; break; } } if (!voiceRef.current) voiceRef.current = v.find(x => x.lang.startsWith('en')) || v[0]; };
    load(); window.speechSynthesis?.addEventListener('voiceschanged', load);
    return () => window.speechSynthesis?.removeEventListener('voiceschanged', load);
  }, []);
  const speak = useCallback((text, onEnd) => { if (!window.speechSynthesis) { onEnd?.(); return; } window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.rate = 0.85; if (voiceRef.current) u.voice = voiceRef.current; u.onstart = () => setIsSpeaking(true); u.onend = () => { setIsSpeaking(false); onEnd?.(); }; u.onerror = () => { setIsSpeaking(false); onEnd?.(); }; setTimeout(() => window.speechSynthesis.speak(u), 150); }, []);
  const stop = useCallback(() => { window.speechSynthesis?.cancel(); setIsSpeaking(false); }, []);
  return { speak, stop, isSpeaking };
}

function useSound() {
  const ctxRef = useRef(null);
  const getCtx = () => { if (!ctxRef.current) ctxRef.current = new (window.AudioContext || window.webkitAudioContext)(); return ctxRef.current; };

  const playMove = useCallback(() => {
    try {
      const ctx = getCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(200, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.05);
      gain.gain.setValueAtTime(0.12, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.1);
    } catch {}
  }, []);

  const playCapture = useCallback(() => {
    try {
      const ctx = getCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(300, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.08);
      gain.gain.setValueAtTime(0.15, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.15);
    } catch {}
  }, []);

  const playGameEnd = useCallback(() => {
    try {
      const ctx = getCtx();
      [261, 329, 392, 523].forEach((f, i) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.value = f;
        gain.gain.setValueAtTime(0.1, ctx.currentTime + i * 0.15);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.15 + 0.4);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start(ctx.currentTime + i * 0.15);
        osc.stop(ctx.currentTime + i * 0.15 + 0.4);
      });
    } catch {}
  }, []);

  const playError = useCallback(() => {
    try {
      const ctx = getCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.value = 150;
      gain.gain.setValueAtTime(0.08, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.2);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.2);
    } catch {}
  }, []);

  return { playMove, playCapture, playGameEnd, playError };
}

function useProgress() {
  const [progress, setProgress] = useState(() => { try { return JSON.parse(localStorage.getItem('chess-progress') || '{}'); } catch { return {}; } });
  const markCompleted = useCallback((k) => { setProgress(p => { const u = { ...p, [k]: { completed: true } }; try { localStorage.setItem('chess-progress', JSON.stringify(u)); } catch {} return u; }); }, []);
  const resetProgress = useCallback(() => { setProgress({}); try { localStorage.removeItem('chess-progress'); } catch {} }, []);
  return { progress, markCompleted, resetProgress };
}

function useGameStats() {
  const [stats, setStats] = useState(() => { 
    try { return JSON.parse(localStorage.getItem('chess-stats') || '{"wins":0,"losses":0,"draws":0,"gamesPlayed":0}'); } 
    catch { return { wins: 0, losses: 0, draws: 0, gamesPlayed: 0 }; } 
  });
  
  const recordWin = useCallback(() => { 
    setStats(s => { 
      const u = { ...s, wins: s.wins + 1, gamesPlayed: s.gamesPlayed + 1 }; 
      try { localStorage.setItem('chess-stats', JSON.stringify(u)); } catch {} 
      return u; 
    }); 
  }, []);
  
  const recordLoss = useCallback(() => { 
    setStats(s => { 
      const u = { ...s, losses: s.losses + 1, gamesPlayed: s.gamesPlayed + 1 }; 
      try { localStorage.setItem('chess-stats', JSON.stringify(u)); } catch {} 
      return u; 
    }); 
  }, []);
  
  const resetStats = useCallback(() => { 
    const u = { wins: 0, losses: 0, draws: 0, gamesPlayed: 0 }; 
    setStats(u); 
    try { localStorage.removeItem('chess-stats'); } catch {} 
  }, []);
  
  return { stats, recordWin, recordLoss, resetStats };
}

// Board themes
const BOARD_THEMES = {
  classic: { light: 'bg-emerald-100', dark: 'bg-emerald-700', name: 'Classic', lastLight: 'bg-yellow-200', lastDark: 'bg-yellow-600' },
  midnight: { light: 'bg-slate-300', dark: 'bg-slate-700', name: 'Midnight', lastLight: 'bg-blue-300', lastDark: 'bg-blue-600' },
  walnut: { light: 'bg-amber-100', dark: 'bg-amber-800', name: 'Walnut', lastLight: 'bg-orange-200', lastDark: 'bg-orange-600' },
  marble: { light: 'bg-gray-100', dark: 'bg-gray-500', name: 'Marble', lastLight: 'bg-gray-200', lastDark: 'bg-gray-400' },
  ocean: { light: 'bg-cyan-100', dark: 'bg-cyan-700', name: 'Ocean', lastLight: 'bg-teal-200', lastDark: 'bg-teal-500' },
};

// Piece styles
const PIECE_STYLES = {
  standard: 'Standard',
  minimal: 'Minimal',
  neo: 'Neo',
};

function usePreferences() {
  const [prefs, setPrefs] = useState(() => {
    try {
      return JSON.parse(localStorage.getItem('chess-prefs') || '{"boardTheme":"classic","pieceStyle":"standard"}');
    } catch {
      return { boardTheme: 'classic', pieceStyle: 'standard' };
    }
  });
  
  const updatePrefs = useCallback((updates) => {
    setPrefs(p => {
      const u = { ...p, ...updates };
      try { localStorage.setItem('chess-prefs', JSON.stringify(u)); } catch {}
      return u;
    });
  }, []);
  
  return { prefs, updatePrefs };
}

// Daily puzzle streak tracking with Firebase
function useDailyStreak(playerName, database) {
  const [streak, setStreak] = useState({ current: 0, best: 0, lastPlayed: null, todayCompleted: false });
  
  useEffect(() => {
    if (!database || !playerName) return;
    const ref = database.ref('players/' + encodeURIComponent(playerName) + '/streak');
    ref.once('value').then(snap => {
      if (snap.exists()) {
        const data = snap.val();
        const today = new Date().toDateString();
        const lastPlayed = data.lastPlayed;
        const yesterday = new Date(Date.now() - 86400000).toDateString();
        
        // Check if streak is still valid
        if (lastPlayed === today) {
          setStreak({ ...data, todayCompleted: true });
        } else if (lastPlayed === yesterday) {
          setStreak({ ...data, todayCompleted: false });
        } else {
          // Streak broken
          setStreak({ current: 0, best: data.best || 0, lastPlayed: null, todayCompleted: false });
        }
      }
    });
  }, [database, playerName]);
  
  const completeDaily = useCallback(() => {
    if (!database || !playerName) return;
    const today = new Date().toDateString();
    if (streak.lastPlayed === today) return; // Already completed today
    
    const newCurrent = streak.current + 1;
    const newBest = Math.max(newCurrent, streak.best);
    const newStreak = { current: newCurrent, best: newBest, lastPlayed: today, todayCompleted: true };
    
    setStreak(newStreak);
    database.ref('players/' + encodeURIComponent(playerName) + '/streak').set({
      current: newCurrent,
      best: newBest,
      lastPlayed: today
    });
  }, [database, playerName, streak]);
  
  return { streak, completeDaily };
}

function usePlayerName() {
  const [name, setName] = useState('');
  const saveName = useCallback((n) => { setName(n); }, []);
  const clearName = useCallback(() => { setName(''); }, []);
  return { name, saveName, clearName };
}

function useTimer(initialMinutes = 10) {
  const [whiteTime, setWhiteTime] = useState(initialMinutes * 60);
  const [blackTime, setBlackTime] = useState(initialMinutes * 60);
  const [isWhiteTurn, setIsWhiteTurn] = useState(true);
  const [isRunning, setIsRunning] = useState(false);
  const intervalRef = useRef(null);

  useEffect(() => {
    if (isRunning) {
      intervalRef.current = setInterval(() => {
        if (isWhiteTurn) setWhiteTime(t => Math.max(0, t - 1));
        else setBlackTime(t => Math.max(0, t - 1));
      }, 1000);
    }
    return () => clearInterval(intervalRef.current);
  }, [isRunning, isWhiteTurn]);

  const switchTurn = () => setIsWhiteTurn(t => !t);
  const start = () => setIsRunning(true);
  const stop = () => setIsRunning(false);
  const reset = (mins = initialMinutes) => { setWhiteTime(mins * 60); setBlackTime(mins * 60); setIsWhiteTurn(true); setIsRunning(false); };

  return { whiteTime, blackTime, isWhiteTurn, switchTurn, start, stop, reset };
}

function formatTime(seconds) {
  const m = Math.floor(seconds / 60);
  const s = seconds % 60;
  return `${m}:${s.toString().padStart(2, '0')}`;
}

// Clean modern chess board with theme support - optimized for mobile & desktop
function ChessBoard({ board, selectedSquare, onSquareClick, lastMove, validMoves = [], disabled, theme = 'classic' }) {
  const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
  const ranks = ['8', '7', '6', '5', '4', '3', '2', '1'];
  const t = BOARD_THEMES[theme] || BOARD_THEMES.classic;

  return (
    <div className="flex items-end gap-0.5 sm:gap-1">
      {/* Rank labels */}
      <div className="flex flex-col pb-4 sm:pb-5">
        {ranks.map(r => (
          <div key={r} className="h-[calc((100vw-3rem)/8)] max-h-10 sm:max-h-14 min-h-8 flex items-center justify-center">
            <span className="text-white/40 text-[10px] sm:text-xs font-medium">{r}</span>
          </div>
        ))}
      </div>
      <div className="flex flex-col">
        {/* Board */}
        <div className="overflow-hidden shadow-2xl border border-white/20 touch-manipulation">
          <div className="grid grid-cols-8">
            {board.map((row, ri) => row.map((piece, ci) => {
              const isLight = (ri + ci) % 2 === 0;
              const isSelected = selectedSquare?.[0] === ri && selectedSquare?.[1] === ci;
              const isLastMoveFrom = lastMove?.from[0] === ri && lastMove?.from[1] === ci;
              const isLastMoveTo = lastMove?.to[0] === ri && lastMove?.to[1] === ci;
              const isValid = validMoves.some(([r, c]) => r === ri && c === ci);
              const Piece = piece ? PIECE_COMPONENTS[piece] : null;
              
              // Color logic with theme
              let bg;
              if (isSelected) {
                bg = 'bg-yellow-400';
              } else if (isLastMoveFrom || isLastMoveTo) {
                bg = isLight ? t.lastLight : t.lastDark;
              } else {
                bg = isLight ? t.light : t.dark;
              }
              
              return (
                <div 
                  key={`${ri}-${ci}`} 
                  onClick={() => !disabled && onSquareClick?.(ri, ci)}
                  className={`
                    w-[calc((100vw-3rem)/8)] max-w-10 sm:max-w-14 min-w-8
                    h-[calc((100vw-3rem)/8)] max-h-10 sm:max-h-14 min-h-8
                    flex items-center justify-center ${bg} 
                    ${!disabled ? 'cursor-pointer active:brightness-90 sm:hover:brightness-110' : ''} 
                    relative transition-colors duration-150 select-none
                  `}
                >
                  {isValid && !Piece && <div className="w-2 h-2 sm:w-3 sm:h-3 rounded-full bg-black/30" />}
                  {Piece && (
                    <div className="w-[85%] h-[85%] pointer-events-none">
                      <Piece />
                    </div>
                  )}
                </div>
              );
            }))}
          </div>
        </div>
        {/* File labels */}
        <div className="flex pt-0.5 sm:pt-1">
          {files.map(f => (
            <div key={f} className="w-[calc((100vw-3rem)/8)] max-w-10 sm:max-w-14 min-w-8 flex items-center justify-center">
              <span className="text-white/40 text-[10px] sm:text-xs font-medium">{f}</span>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

const isWhitePiece = p => p && p === p.toUpperCase();
const isBlackPiece = p => p && p === p.toLowerCase();

function getValidMoves(board, fr, fc) {
  const piece = board[fr][fc]; if (!piece) return [];
  const isW = isWhitePiece(piece), moves = [], pt = piece.toLowerCase();
  const canMoveTo = (r, c) => r >= 0 && r <= 7 && c >= 0 && c <= 7 && (!board[r][c] || (isW ? isBlackPiece(board[r][c]) : isWhitePiece(board[r][c])));
  const empty = (r, c) => r >= 0 && r <= 7 && c >= 0 && c <= 7 && !board[r][c];
  const enemy = (r, c) => r >= 0 && r <= 7 && c >= 0 && c <= 7 && board[r][c] && (isW ? isBlackPiece(board[r][c]) : isWhitePiece(board[r][c]));

  if (pt === 'p') {
    const dir = isW ? -1 : 1, start = isW ? 6 : 1;
    if (empty(fr + dir, fc)) { moves.push([fr + dir, fc]); if (fr === start && empty(fr + 2 * dir, fc)) moves.push([fr + 2 * dir, fc]); }
    if (enemy(fr + dir, fc - 1)) moves.push([fr + dir, fc - 1]);
    if (enemy(fr + dir, fc + 1)) moves.push([fr + dir, fc + 1]);
  }
  if (pt === 'n') { [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]].forEach(([dr, dc]) => { if (canMoveTo(fr + dr, fc + dc)) moves.push([fr + dr, fc + dc]); }); }
  if (pt === 'b' || pt === 'q') { [[-1,-1],[-1,1],[1,-1],[1,1]].forEach(([dr, dc]) => { for (let i = 1; i < 8; i++) { const r = fr + dr * i, c = fc + dc * i; if (r < 0 || r > 7 || c < 0 || c > 7) break; if (empty(r, c)) moves.push([r, c]); else if (enemy(r, c)) { moves.push([r, c]); break; } else break; } }); }
  if (pt === 'r' || pt === 'q') { [[-1,0],[1,0],[0,-1],[0,1]].forEach(([dr, dc]) => { for (let i = 1; i < 8; i++) { const r = fr + dr * i, c = fc + dc * i; if (r < 0 || r > 7 || c < 0 || c > 7) break; if (empty(r, c)) moves.push([r, c]); else if (enemy(r, c)) { moves.push([r, c]); break; } else break; } }); }
  if (pt === 'k') { for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) if ((dr || dc) && canMoveTo(fr + dr, fc + dc)) moves.push([fr + dr, fc + dc]); }
  return moves;
}

function getAllMoves(board, isW) {
  const moves = [];
  for (let r = 0; r < 8; r++) for (let c = 0; c < 8; c++) { const p = board[r][c]; if (p && (isW ? isWhitePiece(p) : isBlackPiece(p))) getValidMoves(board, r, c).forEach(to => moves.push({ from: [r, c], to })); }
  return moves;
}

function evalBoard(board) {
  let score = 0;
  for (let r = 0; r < 8; r++) for (let c = 0; c < 8; c++) {
    const p = board[r][c];
    if (p) {
      const v = PIECE_VALUES[p.toLowerCase()] || 0;
      score += isWhitePiece(p) ? v : -v;
      if ((r === 3 || r === 4) && (c === 3 || c === 4)) score += isWhitePiece(p) ? 0.15 : -0.15;
    }
  }
  return score;
}

function makeMove(board, from, to) {
  const b = deepCopyBoard(board);
  const p = b[from[0]][from[1]];
  b[to[0]][to[1]] = p;
  b[from[0]][from[1]] = null;
  if (p === 'P' && to[0] === 0) b[to[0]][to[1]] = 'Q';
  if (p === 'p' && to[0] === 7) b[to[0]][to[1]] = 'q';
  return b;
}

function getComputerMove(board, difficulty = 'intermediate-1') {
  const moves = getAllMoves(board, false);
  if (!moves.length) return null;
  
  // Always capture king if possible
  for (const m of moves) { if (board[m.to[0]][m.to[1]] === 'K') return m; }
  
  // Beginner 1: Almost entirely random
  if (difficulty === 'beginner-1') {
    if (Math.random() < 0.85) return moves[Math.floor(Math.random() * moves.length)];
    let best = null, bestScore = Infinity;
    for (const m of moves) {
      const nb = makeMove(board, m.from, m.to);
      const s = evalBoard(nb) + (Math.random() - 0.5) * 5;
      if (s < bestScore) { bestScore = s; best = m; }
    }
    return best;
  }
  
  // Beginner 2: Mostly random, occasionally sees captures
  if (difficulty === 'beginner-2') {
    if (Math.random() < 0.6) return moves[Math.floor(Math.random() * moves.length)];
    let best = null, bestScore = Infinity;
    for (const m of moves) {
      const nb = makeMove(board, m.from, m.to);
      const s = evalBoard(nb) + (Math.random() - 0.5) * 3;
      if (s < bestScore) { bestScore = s; best = m; }
    }
    return best;
  }
  
  // Intermediate 1: Considers material with some randomness
  if (difficulty === 'intermediate-1') {
    let best = null, bestScore = Infinity;
    for (const m of moves) {
      const nb = makeMove(board, m.from, m.to);
      const s = evalBoard(nb) + (Math.random() - 0.5) * 2;
      if (s < bestScore) { bestScore = s; best = m; }
    }
    return best;
  }
  
  // Intermediate 2: Looks 1 move ahead with some randomness
  if (difficulty === 'intermediate-2') {
    let best = null, bestScore = Infinity;
    for (const m of moves) {
      const nb = makeMove(board, m.from, m.to);
      let score = evalBoard(nb);
      
      // Look ahead: what's white's best response?
      const whiteMoves = getAllMoves(nb, true);
      let worstForBlack = -Infinity;
      for (const wm of whiteMoves) {
        const nb2 = makeMove(nb, wm.from, wm.to);
        const s2 = evalBoard(nb2);
        if (s2 > worstForBlack) worstForBlack = s2;
      }
      if (whiteMoves.length > 0) score = worstForBlack;
      score += (Math.random() - 0.5) * 1.5;
      
      if (score < bestScore) { bestScore = score; best = m; }
    }
    return best;
  }
  
  // Intermediate 3: Solid 1-ply with position evaluation
  if (difficulty === 'intermediate-3') {
    let best = null, bestScore = Infinity;
    for (const m of moves) {
      const nb = makeMove(board, m.from, m.to);
      let score = evalBoardAdvanced(nb);
      
      const whiteMoves = getAllMoves(nb, true);
      let worstForBlack = -Infinity;
      for (const wm of whiteMoves) {
        const nb2 = makeMove(nb, wm.from, wm.to);
        const s2 = evalBoardAdvanced(nb2);
        if (s2 > worstForBlack) worstForBlack = s2;
      }
      if (whiteMoves.length > 0) score = worstForBlack;
      score += (Math.random() - 0.5) * 0.8;
      
      if (score < bestScore) { bestScore = score; best = m; }
    }
    return best;
  }
  
  // Intermediate 4: Strong 1-ply, minimal randomness
  if (difficulty === 'intermediate-4') {
    let best = null, bestScore = Infinity;
    for (const m of moves) {
      const nb = makeMove(board, m.from, m.to);
      let score = evalBoardAdvanced(nb);
      
      const whiteMoves = getAllMoves(nb, true);
      let worstForBlack = -Infinity;
      for (const wm of whiteMoves) {
        const nb2 = makeMove(nb, wm.from, wm.to);
        const s2 = evalBoardAdvanced(nb2);
        if (s2 > worstForBlack) worstForBlack = s2;
      }
      if (whiteMoves.length > 0) score = worstForBlack;
      score += (Math.random() - 0.5) * 0.3;
      
      if (score < bestScore) { bestScore = score; best = m; }
    }
    return best;
  }
  
  // Advanced 1: 2-ply search (looks 2 moves ahead)
  if (difficulty === 'advanced-1') {
    let best = null, bestScore = Infinity;
    for (const m of moves) {
      const nb = makeMove(board, m.from, m.to);
      let score = minimaxScore(nb, 2, true);
      score += (Math.random() - 0.5) * 0.4;
      if (score < bestScore) { bestScore = score; best = m; }
    }
    return best;
  }
  
  // Advanced 2: 3-ply search
  if (difficulty === 'advanced-2') {
    let best = null, bestScore = Infinity;
    for (const m of moves) {
      const nb = makeMove(board, m.from, m.to);
      let score = minimaxScore(nb, 3, true);
      score += (Math.random() - 0.5) * 0.2;
      if (score < bestScore) { bestScore = score; best = m; }
    }
    return best;
  }
  
  // Advanced 3: 4-ply search with alpha-beta pruning, nearly perfect play
  if (difficulty === 'advanced-3') {
    let best = null, bestScore = Infinity;
    for (const m of moves) {
      const nb = makeMove(board, m.from, m.to);
      let score = alphabeta(nb, 4, -Infinity, Infinity, true);
      score += (Math.random() - 0.5) * 0.1; // Tiny randomness
      if (score < bestScore) { bestScore = score; best = m; }
    }
    return best;
  }
  
  // Default fallback
  return moves[0];
}

// Advanced board evaluation with positional factors
function evalBoardAdvanced(board) {
  let score = 0;
  
  // Piece-square tables for positional play
  const pawnTable = [
    [0,  0,  0,  0,  0,  0,  0,  0],
    [50, 50, 50, 50, 50, 50, 50, 50],
    [10, 10, 20, 30, 30, 20, 10, 10],
    [5,  5, 10, 25, 25, 10,  5,  5],
    [0,  0,  0, 20, 20,  0,  0,  0],
    [5, -5,-10,  0,  0,-10, -5,  5],
    [5, 10, 10,-20,-20, 10, 10,  5],
    [0,  0,  0,  0,  0,  0,  0,  0]
  ];
  
  const knightTable = [
    [-50,-40,-30,-30,-30,-30,-40,-50],
    [-40,-20,  0,  0,  0,  0,-20,-40],
    [-30,  0, 10, 15, 15, 10,  0,-30],
    [-30,  5, 15, 20, 20, 15,  5,-30],
    [-30,  0, 15, 20, 20, 15,  0,-30],
    [-30,  5, 10, 15, 15, 10,  5,-30],
    [-40,-20,  0,  5,  5,  0,-20,-40],
    [-50,-40,-30,-30,-30,-30,-40,-50]
  ];
  
  const bishopTable = [
    [-20,-10,-10,-10,-10,-10,-10,-20],
    [-10,  0,  0,  0,  0,  0,  0,-10],
    [-10,  0, 10, 10, 10, 10,  0,-10],
    [-10,  5,  5, 10, 10,  5,  5,-10],
    [-10,  0, 10, 10, 10, 10,  0,-10],
    [-10, 10, 10, 10, 10, 10, 10,-10],
    [-10,  5,  0,  0,  0,  0,  5,-10],
    [-20,-10,-10,-10,-10,-10,-10,-20]
  ];
  
  const rookTable = [
    [0,  0,  0,  0,  0,  0,  0,  0],
    [5, 10, 10, 10, 10, 10, 10,  5],
    [-5,  0,  0,  0,  0,  0,  0, -5],
    [-5,  0,  0,  0,  0,  0,  0, -5],
    [-5,  0,  0,  0,  0,  0,  0, -5],
    [-5,  0,  0,  0,  0,  0,  0, -5],
    [-5,  0,  0,  0,  0,  0,  0, -5],
    [0,  0,  0,  5,  5,  0,  0,  0]
  ];
  
  for (let r = 0; r < 8; r++) {
    for (let c = 0; c < 8; c++) {
      const p = board[r][c];
      if (!p) continue;
      
      const isW = isWhitePiece(p);
      const pt = p.toLowerCase();
      const v = PIECE_VALUES[pt] || 0;
      const row = isW ? r : 7 - r;
      
      let posBonus = 0;
      if (pt === 'p') posBonus = pawnTable[row][c] / 100;
      else if (pt === 'n') posBonus = knightTable[row][c] / 100;
      else if (pt === 'b') posBonus = bishopTable[row][c] / 100;
      else if (pt === 'r') posBonus = rookTable[row][c] / 100;
      else if (pt === 'q') posBonus = ((r === 3 || r === 4) && (c === 3 || c === 4)) ? 0.1 : 0;
      else if (pt === 'k') posBonus = 0;
      
      score += isW ? (v + posBonus) : -(v + posBonus);
    }
  }
  
  return score;
}

// Minimax algorithm for deeper search
function minimaxScore(board, depth, isMaximizing) {
  if (depth === 0) return evalBoardAdvanced(board);
  
  const moves = getAllMoves(board, isMaximizing);
  if (!moves.length) return isMaximizing ? -1000 : 1000;
  
  if (isMaximizing) {
    let maxEval = -Infinity;
    for (const m of moves) {
      const nb = makeMove(board, m.from, m.to);
      const ev = minimaxScore(nb, depth - 1, false);
      maxEval = Math.max(maxEval, ev);
    }
    return maxEval;
  } else {
    let minEval = Infinity;
    for (const m of moves) {
      const nb = makeMove(board, m.from, m.to);
      const ev = minimaxScore(nb, depth - 1, true);
      minEval = Math.min(minEval, ev);
    }
    return minEval;
  }
}

// Alpha-beta pruning for efficient deep search
function alphabeta(board, depth, alpha, beta, isMaximizing) {
  if (depth === 0) return evalBoardAdvanced(board);
  
  const moves = getAllMoves(board, isMaximizing);
  if (!moves.length) return isMaximizing ? -1000 : 1000;
  
  // Sort moves for better pruning (captures first)
  moves.sort((a, b) => {
    const capA = board[a.to[0]][a.to[1]] ? 1 : 0;
    const capB = board[b.to[0]][b.to[1]] ? 1 : 0;
    return capB - capA;
  });
  
  if (isMaximizing) {
    let maxEval = -Infinity;
    for (const m of moves) {
      const nb = makeMove(board, m.from, m.to);
      const ev = alphabeta(nb, depth - 1, alpha, beta, false);
      maxEval = Math.max(maxEval, ev);
      alpha = Math.max(alpha, ev);
      if (beta <= alpha) break;
    }
    return maxEval;
  } else {
    let minEval = Infinity;
    for (const m of moves) {
      const nb = makeMove(board, m.from, m.to);
      const ev = alphabeta(nb, depth - 1, alpha, beta, true);
      minEval = Math.min(minEval, ev);
      beta = Math.min(beta, ev);
      if (beta <= alpha) break;
    }
    return minEval;
  }
}

function calculateScore(captured) {
  return captured.reduce((sum, p) => sum + (PIECE_VALUES[p.toLowerCase()] || 0), 0);
}

function CapturedPieces({ pieces }) {
  const sorted = [...pieces].sort((a, b) => (PIECE_VALUES[b.toLowerCase()] || 0) - (PIECE_VALUES[a.toLowerCase()] || 0));
  if (!sorted.length) return <span className="text-white/30 text-sm">‚Äî</span>;
  return <div className="flex flex-wrap gap-0.5">{sorted.map((p, i) => <span key={i} className="text-lg">{PIECE_SYMBOLS[p]}</span>)}</div>;
}

function PlayerCard({ name, isWhite, time, isActive, score, capturedPieces, isComputer }) {
  return (
    <div className={`border p-3 transition-all ${isActive ? 'border-white bg-white/5' : 'border-white/10'}`}>
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center gap-2 min-w-0">
          <div className={`w-3 h-3 rounded-full flex-shrink-0 ${isWhite ? 'bg-white' : 'bg-white/20 border border-white/40'}`} />
          <span className="text-white font-light text-sm truncate">{name}</span>
          {isComputer && <span className="text-[10px] border border-white/20 px-1.5 py-0.5 text-white/50 flex-shrink-0">CPU</span>}
        </div>
        <div className={`text-lg font-mono flex-shrink-0 ${isActive ? 'text-white' : 'text-white/40'}`}>
          {formatTime(time)}
        </div>
      </div>
      <div className="flex items-center justify-between">
        <div className="flex-1 min-w-0"><CapturedPieces pieces={capturedPieces} /></div>
        <div className="text-white/60 text-sm flex-shrink-0">+{score}</div>
      </div>
    </div>
  );
}

function PlayMatch({ playerName, onBack, soundEnabled, onWin, onLoss, boardTheme }) {
  const [board, setBoard] = useState(deepCopyBoard(INITIAL_BOARD));
  const [selected, setSelected] = useState(null);
  const [valid, setValid] = useState([]);
  const [lastMove, setLastMove] = useState(null);
  const [status, setStatus] = useState('selecting'); // 'selecting', 'playing', 'kingCaptured', 'timeout'
  const [difficulty, setDifficulty] = useState(null);
  const [winner, setWinner] = useState(null);
  const [history, setHistory] = useState([]);
  const [whiteCaptured, setWhiteCaptured] = useState([]);
  const [blackCaptured, setBlackCaptured] = useState([]);
  const [thinking, setThinking] = useState(false);
  const [boardHistory, setBoardHistory] = useState([{ board: deepCopyBoard(INITIAL_BOARD), whiteCaptured: [], blackCaptured: [] }]);
  const { playMove, playCapture, playGameEnd } = useSound();
  const timer = useTimer(10);
  const files = ['a','b','c','d','e','f','g','h'];

  const isWhiteTurn = timer.isWhiteTurn;

  useEffect(() => { if (history.length === 1 && !timer.isRunning) timer.start(); }, [history.length]);

  useEffect(() => {
    if (timer.whiteTime === 0 && status === 'playing') { setStatus('timeout'); setWinner('black'); timer.stop(); if (soundEnabled) playGameEnd(); onLoss?.(); }
    if (timer.blackTime === 0 && status === 'playing') { setStatus('timeout'); setWinner('white'); timer.stop(); if (soundEnabled) playGameEnd(); onWin?.(); }
  }, [timer.whiteTime, timer.blackTime, status]);

  const startGame = (diff) => {
    setDifficulty(diff);
    setStatus('playing');
  };

  const notation = (from, to, p, cap) => {
    const pc = p.toLowerCase() === 'p' ? '' : p.toUpperCase();
    return `${p.toLowerCase() === 'p' && cap ? files[from[1]] : ''}${pc}${cap ? 'x' : ''}${files[to[1]]}${8 - to[0]}`;
  };

  // Undo last two moves (player + computer)
  const handleUndo = () => {
    if (boardHistory.length <= 1 || thinking || status !== 'playing') return;
    // Go back 2 moves (player + CPU response)
    const targetIdx = Math.max(0, boardHistory.length - 3);
    const prevState = boardHistory[targetIdx];
    setBoard(deepCopyBoard(prevState.board));
    setWhiteCaptured([...prevState.whiteCaptured]);
    setBlackCaptured([...prevState.blackCaptured]);
    setBoardHistory(h => h.slice(0, targetIdx + 1));
    setHistory(h => h.slice(0, targetIdx));
    setLastMove(null);
    setSelected(null);
    setValid([]);
  };

  const handleClick = (r, c) => {
    if (status !== 'playing' || !isWhiteTurn || thinking) return;
    const p = board[r][c];
    
    if (selected) {
      if (valid.some(([vr, vc]) => vr === r && vc === c)) {
        const mp = board[selected[0]][selected[1]];
        const cap = board[r][c];
        
        if (cap?.toLowerCase() === 'k') {
          const nb = makeMove(board, selected, [r, c]);
          setBoard(nb); setLastMove({ from: selected, to: [r, c] });
          setHistory(h => [...h, notation(selected, [r, c], mp, cap)]);
          const newWhiteCap = cap ? [...whiteCaptured, cap] : whiteCaptured;
          if (cap) setWhiteCaptured(newWhiteCap);
          setBoardHistory(h => [...h, { board: nb, whiteCaptured: newWhiteCap, blackCaptured }]);
          setStatus('kingCaptured'); setWinner('white'); timer.stop();
          if (soundEnabled) playGameEnd();
          onWin?.();
          setSelected(null); setValid([]);
          return;
        }
        
        const nb = makeMove(board, selected, [r, c]);
        if (soundEnabled) cap ? playCapture() : playMove();
        const newWhiteCap = cap ? [...whiteCaptured, cap] : whiteCaptured;
        if (cap) setWhiteCaptured(newWhiteCap);
        
        setBoard(nb); setLastMove({ from: selected, to: [r, c] });
        setHistory(h => [...h, notation(selected, [r, c], mp, cap)]);
        setBoardHistory(h => [...h, { board: nb, whiteCaptured: newWhiteCap, blackCaptured }]);
        timer.switchTurn(); setSelected(null); setValid([]);
        
        // CPU move with delay - no hints, just thinking then move
        setThinking(true);
        
        // Thinking time varies by difficulty - advanced takes longer
        const thinkTimes = {
          'beginner-1': 800,
          'beginner-2': 1000,
          'intermediate-1': 1200,
          'intermediate-2': 1500,
          'intermediate-3': 1800,
          'intermediate-4': 2000,
          'advanced-1': 2500,
          'advanced-2': 3500,
          'advanced-3': 4500,
        };
        const thinkTime = thinkTimes[difficulty] || 1500;
        
        setTimeout(() => {
          const cm = getComputerMove(nb, difficulty);
          if (cm) {
            const cp = nb[cm.from[0]][cm.from[1]];
            const cc = nb[cm.to[0]][cm.to[1]];
            
            if (cc?.toLowerCase() === 'k') {
              const ab = makeMove(nb, cm.from, cm.to);
              const newBlackCap = cc ? [...blackCaptured, cc] : blackCaptured;
              setBoard(ab); 
              setLastMove(cm);
              setHistory(h => [...h, notation(cm.from, cm.to, cp, cc)]);
              if (cc) setBlackCaptured(newBlackCap);
              setBoardHistory(h => [...h, { board: ab, whiteCaptured: newWhiteCap, blackCaptured: newBlackCap }]);
              setStatus('kingCaptured'); setWinner('black'); timer.stop();
              if (soundEnabled) playGameEnd();
              onLoss?.();
              setThinking(false);
              return;
            }
            
            const ab = makeMove(nb, cm.from, cm.to);
            if (soundEnabled) cc ? playCapture() : playMove();
            const newBlackCap = cc ? [...blackCaptured, cc] : blackCaptured;
            if (cc) setBlackCaptured(newBlackCap);
            
            setBoard(ab); 
            setLastMove(cm); // Highlights both FROM and TO squares after move
            setHistory(h => [...h, notation(cm.from, cm.to, cp, cc)]);
            setBoardHistory(h => [...h, { board: ab, whiteCaptured: newWhiteCap, blackCaptured: newBlackCap }]);
            timer.switchTurn();
            setThinking(false);
          } else {
            setThinking(false);
          }
        }, thinkTime);
        
      } else if (p && isWhitePiece(p)) {
        setSelected([r, c]); setValid(getValidMoves(board, r, c));
      } else {
        setSelected(null); setValid([]);
      }
    } else if (p && isWhitePiece(p)) {
      setSelected([r, c]); setValid(getValidMoves(board, r, c));
    }
  };

  const reset = () => {
    setBoard(deepCopyBoard(INITIAL_BOARD)); setSelected(null); setValid([]); setLastMove(null);
    setStatus('selecting'); setDifficulty(null); setWinner(null); setHistory([]);
    setWhiteCaptured([]); setBlackCaptured([]); setThinking(false);
    setBoardHistory([{ board: deepCopyBoard(INITIAL_BOARD), whiteCaptured: [], blackCaptured: [] }]);
    timer.reset();
    setShowConfirm(false);
  };

  const rematch = () => {
    setBoard(deepCopyBoard(INITIAL_BOARD)); setSelected(null); setValid([]); setLastMove(null);
    setStatus('playing'); setWinner(null); setHistory([]);
    setWhiteCaptured([]); setBlackCaptured([]); setThinking(false);
    setBoardHistory([{ board: deepCopyBoard(INITIAL_BOARD), whiteCaptured: [], blackCaptured: [] }]);
    timer.reset();
  };

  const [showConfirm, setShowConfirm] = useState(false);

  const handleBackClick = () => {
    if (status === 'playing') {
      setShowConfirm(true);
    } else {
      onBack();
    }
  };

  const whiteScore = calculateScore(whiteCaptured);
  const blackScore = calculateScore(blackCaptured);
  const materialDiff = whiteScore - blackScore;
  const canUndo = boardHistory.length > 1 && status === 'playing' && !thinking && isWhiteTurn;

  const DIFFICULTY_LEVELS = [
    { id: 'beginner-1', name: 'Novice', desc: 'Learning the basics', depth: 0 },
    { id: 'intermediate-1', name: 'Casual', desc: 'Relaxed gameplay', depth: 1 },
    { id: 'intermediate-3', name: 'Club', desc: 'Solid competition', depth: 2 },
    { id: 'advanced-1', name: 'Expert', desc: 'Serious challenge', depth: 3 },
    { id: 'advanced-3', name: 'Master', desc: 'Near-perfect play', depth: 4 },
  ];

  // Difficulty selection screen
  if (status === 'selecting') {
    return (
      <div className="min-h-screen bg-black p-4 sm:p-6">
        <div className="max-w-md mx-auto">
          <button onClick={onBack} className="text-white/40 hover:text-white text-sm mb-8">‚Üê Back</button>
          
          <div className="text-center mb-10">
            <h1 className="text-2xl font-light tracking-widest text-white uppercase">Select Level</h1>
            <div className="w-12 h-px bg-white/30 mx-auto mt-4" />
          </div>
          
          <div className="space-y-3">
            {DIFFICULTY_LEVELS.map((level, idx) => (
              <button 
                key={level.id} 
                onClick={() => startGame(level.id)} 
                className="w-full p-4 border border-white/20 hover:border-white/40 hover:bg-white/5 transition-all group"
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-4">
                    <div className="flex gap-1">
                      {Array.from({ length: 5 }).map((_, i) => (
                        <div key={i} className={`w-1.5 h-4 ${i <= idx ? 'bg-white' : 'bg-white/20'}`} />
                      ))}
                    </div>
                    <div className="text-left">
                      <h2 className="text-white font-light tracking-wide">{level.name}</h2>
                      <p className="text-white/40 text-xs mt-0.5">{level.desc}</p>
                    </div>
                  </div>
                  <span className="text-white/30 group-hover:text-white/60">‚Üí</span>
                </div>
              </button>
            ))}
          </div>
        </div>
      </div>
    );
  }

  const getDifficultyDisplay = () => {
    const level = DIFFICULTY_LEVELS.find(l => l.id === difficulty);
    return level ? level.name : difficulty;
  };

  return (
    <div className="min-h-screen bg-black p-2 sm:p-4 lg:p-6">
      <ConfirmModal 
        show={showConfirm}
        title="Leave Game?"
        message="Your current game progress will be lost."
        onConfirm={onBack}
        onCancel={() => setShowConfirm(false)}
      />
      <div className="max-w-5xl mx-auto">
        {/* Header */}
        <div className="mb-3 sm:mb-4">
          <button onClick={handleBackClick} className="text-white/40 hover:text-white text-xs sm:text-sm mb-2">‚Üê Leave</button>
          <div className="flex items-center gap-3">
            <h1 className="text-lg sm:text-xl font-light tracking-wide text-white">vs Computer</h1>
            <span className="text-[10px] sm:text-xs px-2 py-0.5 border border-white/20 text-white/60">{getDifficultyDisplay()}</span>
          </div>
        </div>

        {/* Mobile: Opponent info bar above board */}
        <div className="lg:hidden mb-2">
          <div className={`border p-2 flex items-center justify-between ${!isWhiteTurn && status === 'playing' ? 'border-white bg-white/5' : 'border-white/10'}`}>
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 rounded-full bg-white/20 border border-white/40" />
              <span className="text-white text-sm">Computer</span>
              <span className="text-[10px] border border-white/20 px-1 text-white/40">CPU</span>
            </div>
            <div className={`font-mono ${!isWhiteTurn ? 'text-white' : 'text-white/40'}`}>{formatTime(timer.blackTime)}</div>
          </div>
        </div>

        <div className="flex flex-col lg:flex-row gap-3 sm:gap-6 items-center lg:items-start">
          {/* Chess Board */}
          <div className="flex-shrink-0">
            <ChessBoard board={board} selectedSquare={selected} onSquareClick={handleClick} lastMove={lastMove} validMoves={valid} disabled={status !== 'playing' || !isWhiteTurn || thinking} theme={boardTheme} />
          </div>

          {/* Mobile: Player info bar below board */}
          <div className="lg:hidden w-full">
            <div className={`border p-2 flex items-center justify-between ${isWhiteTurn && status === 'playing' ? 'border-white bg-white/5' : 'border-white/10'}`}>
              <div className="flex items-center gap-2">
                <div className="w-3 h-3 rounded-full bg-white" />
                <span className="text-white text-sm">{playerName}</span>
              </div>
              <div className={`font-mono ${isWhiteTurn ? 'text-white' : 'text-white/40'}`}>{formatTime(timer.whiteTime)}</div>
            </div>
          </div>

          {/* Status messages - show on mobile */}
          {(status === 'kingCaptured' || status === 'timeout') && (
            <div className={`lg:hidden w-full border p-3 text-center ${winner === 'white' ? 'border-white bg-white/10' : 'border-white/30'}`}>
              <p className="text-lg text-white">
                {status === 'kingCaptured' && (winner === 'white' ? 'You Win' : 'You Lost')}
                {status === 'timeout' && (winner === 'white' ? 'You Win' : 'Time Out')}
              </p>
            </div>
          )}

          {thinking && (
            <div className="lg:hidden w-full border border-white/20 p-2 text-center">
              <p className="text-white/60 animate-pulse text-sm">Thinking...</p>
            </div>
          )}

          {/* Mobile controls */}
          <div className="lg:hidden w-full space-y-2">
            <GameControls 
              onUndo={handleUndo} 
              canUndo={canUndo}
              onRematch={winner ? rematch : null}
              showRematch={!!winner}
            />
            <button onClick={reset} className="w-full py-2.5 border border-white/30 text-white/60 hover:text-white hover:border-white/50 text-sm transition-all">
              New Game
            </button>
          </div>

          {/* Desktop sidebar */}
          <div className="hidden lg:block flex-1 w-full max-w-xs space-y-3">
            <PlayerCard name="Computer" isWhite={false} time={timer.blackTime} isActive={!isWhiteTurn && status === 'playing'} score={blackScore} capturedPieces={blackCaptured} isComputer />

            {(status === 'kingCaptured' || status === 'timeout') && (
              <div className={`border p-4 text-center ${winner === 'white' ? 'border-white bg-white/10' : 'border-white/30'}`}>
                <p className="text-lg text-white mb-1">
                  {status === 'kingCaptured' && (winner === 'white' ? 'King Captured' : 'Your King Captured')}
                  {status === 'timeout' && (winner === 'white' ? 'Time Out' : 'You Ran Out of Time')}
                </p>
                <p className="text-white/60">{winner === 'white' ? 'You Win!' : 'Computer Wins'}</p>
              </div>
            )}

            {thinking && (
              <div className="border border-white/20 p-3 text-center">
                <p className="text-white/60 animate-pulse">Thinking...</p>
              </div>
            )}

            <PlayerCard name={playerName} isWhite={true} time={timer.whiteTime} isActive={isWhiteTurn && status === 'playing'} score={whiteScore} capturedPieces={whiteCaptured} isComputer={false} />

            <div className="border border-white/10 p-3 text-center">
              <span className="text-white/40 text-sm">Material: </span>
              <span className={`font-medium ${materialDiff > 0 ? 'text-white' : materialDiff < 0 ? 'text-white/50' : 'text-white/60'}`}>
                {materialDiff > 0 ? `+${materialDiff}` : materialDiff < 0 ? materialDiff : 'Even'}
              </span>
            </div>

            <div className="border border-white/10 p-3 max-h-32 overflow-y-auto">
              <p className="text-white/30 text-xs uppercase mb-2 tracking-wide">Moves</p>
              <div className="space-y-1 font-mono text-xs">
                {!history.length && <p className="text-white/20">No moves yet</p>}
                {Array.from({ length: Math.ceil(history.length / 2) }).map((_, i) => (
                  <div key={i} className="flex gap-2">
                    <span className="text-white/30 w-4">{i + 1}.</span>
                    <span className="text-white w-12">{history[i * 2]}</span>
                    <span className="text-white/50">{history[i * 2 + 1] || ''}</span>
                  </div>
                ))}
              </div>
            </div>

            <GameControls 
              onUndo={handleUndo} 
              canUndo={canUndo}
              onRematch={winner ? rematch : null}
              showRematch={!!winner}
            />
            
            <button onClick={reset} className="w-full py-2.5 border border-white/30 text-white/60 hover:text-white hover:border-white/50 transition-all">
              New Game
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function PlayMultiplayer({ player1Name, onBack, soundEnabled, boardTheme }) {
  const [board, setBoard] = useState(deepCopyBoard(INITIAL_BOARD));
  const [selected, setSelected] = useState(null);
  const [valid, setValid] = useState([]);
  const [lastMove, setLastMove] = useState(null);
  const [status, setStatus] = useState('setup'); // 'setup', 'playing', 'kingCaptured', 'timeout'
  const [player2Name, setPlayer2Name] = useState('');
  const [winner, setWinner] = useState(null);
  const [history, setHistory] = useState([]);
  const [whiteCaptured, setWhiteCaptured] = useState([]);
  const [blackCaptured, setBlackCaptured] = useState([]);
  const { playMove, playCapture, playGameEnd } = useSound();
  const timer = useTimer(10);
  const files = ['a','b','c','d','e','f','g','h'];

  const isWhiteTurn = timer.isWhiteTurn;

  useEffect(() => { if (history.length === 1 && !timer.isRunning) timer.start(); }, [history.length]);

  useEffect(() => {
    if (timer.whiteTime === 0 && status === 'playing') { setStatus('timeout'); setWinner('black'); timer.stop(); if (soundEnabled) playGameEnd(); }
    if (timer.blackTime === 0 && status === 'playing') { setStatus('timeout'); setWinner('white'); timer.stop(); if (soundEnabled) playGameEnd(); }
  }, [timer.whiteTime, timer.blackTime, status]);

  const startGame = () => {
    if (player2Name.trim()) {
      setStatus('playing');
    }
  };

  const notation = (from, to, p, cap) => {
    const pc = p.toLowerCase() === 'p' ? '' : p.toUpperCase();
    return `${p.toLowerCase() === 'p' && cap ? files[from[1]] : ''}${pc}${cap ? 'x' : ''}${files[to[1]]}${8 - to[0]}`;
  };

  const handleClick = (r, c) => {
    if (status !== 'playing') return;
    const p = board[r][c];
    const isCurrentPlayerPiece = isWhiteTurn ? isWhitePiece(p) : isBlackPiece(p);
    
    if (selected) {
      if (valid.some(([vr, vc]) => vr === r && vc === c)) {
        const mp = board[selected[0]][selected[1]];
        const cap = board[r][c];
        
        if (cap?.toLowerCase() === 'k') {
          const nb = makeMove(board, selected, [r, c]);
          setBoard(nb); setLastMove({ from: selected, to: [r, c] });
          setHistory(h => [...h, notation(selected, [r, c], mp, cap)]);
          if (cap) {
            if (isWhiteTurn) setWhiteCaptured(prev => [...prev, cap]);
            else setBlackCaptured(prev => [...prev, cap]);
          }
          setStatus('kingCaptured'); setWinner(isWhiteTurn ? 'white' : 'black'); timer.stop();
          if (soundEnabled) playGameEnd();
          setSelected(null); setValid([]);
          return;
        }
        
        const nb = makeMove(board, selected, [r, c]);
        if (soundEnabled) cap ? playCapture() : playMove();
        if (cap) {
          if (isWhiteTurn) setWhiteCaptured(prev => [...prev, cap]);
          else setBlackCaptured(prev => [...prev, cap]);
        }
        
        setBoard(nb); setLastMove({ from: selected, to: [r, c] });
        setHistory(h => [...h, notation(selected, [r, c], mp, cap)]);
        timer.switchTurn(); setSelected(null); setValid([]);
        
      } else if (isCurrentPlayerPiece) {
        setSelected([r, c]); setValid(getValidMoves(board, r, c));
      } else {
        setSelected(null); setValid([]);
      }
    } else if (isCurrentPlayerPiece) {
      setSelected([r, c]); setValid(getValidMoves(board, r, c));
    }
  };

  const reset = () => {
    setBoard(deepCopyBoard(INITIAL_BOARD)); setSelected(null); setValid([]); setLastMove(null);
    setStatus('setup'); setWinner(null); setHistory([]);
    setWhiteCaptured([]); setBlackCaptured([]); setPlayer2Name('');
    timer.reset();
    setShowConfirm(false);
  };

  const [showConfirm, setShowConfirm] = useState(false);

  const handleBackClick = () => {
    if (status === 'playing') {
      setShowConfirm(true);
    } else {
      onBack();
    }
  };

  const whiteScore = calculateScore(whiteCaptured);
  const blackScore = calculateScore(blackCaptured);
  const materialDiff = whiteScore - blackScore;

  // Player 2 name entry
  if (status === 'setup') {
    return (
      <div className="min-h-screen bg-black p-4 sm:p-6">
        <div className="max-w-md mx-auto">
          <button onClick={onBack} className="text-white/40 hover:text-white text-sm mb-8">‚Üê Back</button>
          
          <div className="text-center mb-10">
            <h1 className="text-2xl font-light tracking-widest text-white uppercase">Local Match</h1>
            <div className="w-12 h-px bg-white/30 mx-auto mt-4" />
          </div>
          
          <div className="border border-white/20 p-6 mb-6">
            <div className="flex items-center gap-4 mb-6 pb-6 border-b border-white/10">
              <div className="w-3 h-3 rounded-full bg-white" />
              <div>
                <p className="text-white font-light">{player1Name}</p>
                <p className="text-white/40 text-xs">White</p>
              </div>
            </div>
            <div className="flex items-center gap-4">
              <div className="w-3 h-3 rounded-full bg-white/30 border border-white/50" />
              <div className="flex-1">
                <input 
                  type="text" 
                  value={player2Name} 
                  onChange={e => setPlayer2Name(e.target.value)}
                  placeholder="Enter name"
                  className="w-full bg-transparent border-b border-white/30 focus:border-white px-0 py-2 text-white placeholder-white/30 focus:outline-none transition-colors"
                  onKeyDown={e => e.key === 'Enter' && player2Name.trim() && startGame()}
                  autoFocus
                />
                <p className="text-white/40 text-xs mt-2">Black</p>
              </div>
            </div>
          </div>
          
          <button 
            onClick={startGame}
            disabled={!player2Name.trim()}
            className="w-full py-3 bg-white text-black font-medium tracking-wide uppercase text-sm hover:bg-white/90 disabled:bg-white/20 disabled:text-white/40 transition-all"
          >
            Start
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-black p-4 sm:p-6">
      <ConfirmModal 
        show={showConfirm}
        title="Leave Game?"
        message="Your current game progress will be lost."
        onConfirm={onBack}
        onCancel={() => setShowConfirm(false)}
      />
      <div className="max-w-5xl mx-auto">
        <div className="mb-4">
          <button onClick={handleBackClick} className="text-white/40 hover:text-white text-sm mb-2">‚Üê Leave</button>
          <div className="flex items-center gap-3">
            <h1 className="text-xl font-light tracking-wide text-white">Local Match</h1>
          </div>
        </div>

        <div className="flex flex-col lg:flex-row gap-6 items-start">
          <ChessBoard board={board} selectedSquare={selected} onSquareClick={handleClick} lastMove={lastMove} validMoves={valid} disabled={status !== 'playing'} theme={boardTheme} />

          <div className="flex-1 w-full max-w-xs space-y-3">
            <PlayerCard name={player2Name} isWhite={false} time={timer.blackTime} isActive={!isWhiteTurn && status === 'playing'} score={blackScore} capturedPieces={blackCaptured} isComputer={false} />

            {(status === 'kingCaptured' || status === 'timeout') && (
              <div className="border border-white bg-white/10 p-4 text-center">
                <p className="text-lg text-white mb-1">
                  {status === 'kingCaptured' && 'King Captured'}
                  {status === 'timeout' && 'Time Out'}
                </p>
                <p className="text-white/60">{winner === 'white' ? `${player1Name} Wins` : `${player2Name} Wins`}</p>
              </div>
            )}

            {status === 'playing' && (
              <div className={`border p-3 text-center ${isWhiteTurn ? 'border-white bg-white/5' : 'border-white/10'}`}>
                <p className={`${isWhiteTurn ? 'text-white' : 'text-white/50'}`}>
                  {isWhiteTurn ? `${player1Name}'s turn` : `${player2Name}'s turn`}
                </p>
              </div>
            )}

            <PlayerCard name={player1Name} isWhite={true} time={timer.whiteTime} isActive={isWhiteTurn && status === 'playing'} score={whiteScore} capturedPieces={whiteCaptured} isComputer={false} />

            <div className="border border-white/10 p-3 text-center">
              <span className="text-white/40 text-sm">Material: </span>
              <span className={`font-medium ${materialDiff > 0 ? 'text-white' : materialDiff < 0 ? 'text-white/50' : 'text-white/60'}`}>
                {materialDiff > 0 ? `+${materialDiff}` : materialDiff < 0 ? materialDiff : 'Even'}
              </span>
            </div>

            <div className="border border-white/10 p-3 max-h-32 overflow-y-auto">
              <p className="text-white/30 text-xs uppercase mb-2 tracking-wide">Moves</p>
              <div className="space-y-1 font-mono text-xs">
                {!history.length && <p className="text-white/20">No moves yet</p>}
                {Array.from({ length: Math.ceil(history.length / 2) }).map((_, i) => (
                  <div key={i} className="flex gap-2">
                    <span className="text-white/30 w-4">{i + 1}.</span>
                    <span className="text-white w-12">{history[i * 2]}</span>
                    <span className="text-white/50">{history[i * 2 + 1] || ''}</span>
                  </div>
                ))}
              </div>
            </div>

            <button onClick={reset} className="w-full py-2.5 border border-white/20 text-white/60 hover:text-white hover:border-white/40 transition-all">
              New Game
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// Generate random game code
function generateGameCode() {
  const words = ['KNIGHT', 'BISHOP', 'CASTLE', 'QUEEN', 'KING', 'PAWN', 'ROOK', 'CHECK'];
  const word = words[Math.floor(Math.random() * words.length)];
  const num = Math.floor(1000 + Math.random() * 9000);
  return `${word}-${num}`;
}

// Convert board to string for Firebase storage (prevents array corruption)
function boardToString(board) {
  return board.map(row => row.map(c => c || '.').join('')).join('/');
}

// Convert string back to board array
function stringToBoard(str) {
  if (!str) return deepCopyBoard(INITIAL_BOARD);
  return str.split('/').map(row => row.split('').map(c => c === '.' ? null : c));
}

// Online Multiplayer with Firebase
function PlayOnline({ playerName, onBack, soundEnabled, onWin, onLoss, boardTheme }) {
  const [mode, setMode] = useState('menu'); // menu, waiting, playing
  const [gameCode, setGameCode] = useState('');
  const [inputCode, setInputCode] = useState('');
  const [myColor, setMyColor] = useState(null);
  const [opponent, setOpponent] = useState('');
  const [board, setBoard] = useState(deepCopyBoard(INITIAL_BOARD));
  const [isWhiteTurn, setIsWhiteTurn] = useState(true);
  const [selected, setSelected] = useState(null);
  const [validMoves, setValidMoves] = useState([]);
  const [lastMove, setLastMove] = useState(null);
  const [winner, setWinner] = useState(null);
  const [history, setHistory] = useState([]);
  const [whiteCaptured, setWhiteCaptured] = useState([]);
  const [blackCaptured, setBlackCaptured] = useState([]);
  const [error, setError] = useState('');
  const [copied, setCopied] = useState(false);
  const { playMove, playCapture, playGameEnd } = useSound();
  const unsubRef = useRef(null);
  const database = window.firebaseDatabase;
  const files = ['a','b','c','d','e','f','g','h'];

  const cleanup = () => {
    if (unsubRef.current) {
      unsubRef.current();
      unsubRef.current = null;
    }
  };

  useEffect(() => cleanup, []);

  const subscribe = (code, color) => {
    cleanup();
    if (!database) return;
    
    const ref = database.ref('games/' + code);
    let hasOpponentJoined = false;
    
    const cb = ref.on('value', snap => {
      const data = snap.val();
      if (!data) return;
      
      // Check if opponent joined (for host)
      if (color === 'white' && data.guest && !hasOpponentJoined) {
        hasOpponentJoined = true;
        setOpponent(data.guest);
        setMode('playing');
      }
      
      // Set opponent name for guest
      if (color === 'black' && data.host) {
        setOpponent(data.host);
      }
      
      setBoard(stringToBoard(data.board));
      setIsWhiteTurn(data.isWhiteTurn !== false);
      setLastMove(data.lastMove || null);
      setHistory(data.history || []);
      setWhiteCaptured(data.whiteCaptured || []);
      setBlackCaptured(data.blackCaptured || []);
      
      if (data.winner && !winner) {
        setWinner(data.winner);
        if (soundEnabled) playGameEnd();
        // Track stats
        if (data.winner === color) {
          onWin?.();
        } else {
          onLoss?.();
        }
      }
    });
    unsubRef.current = () => ref.off('value', cb);
  };

  const createGame = async () => {
    if (!database) {
      setError('Firebase not connected. Check your internet.');
      return;
    }
    
    const code = generateGameCode();
    setError('');
    
    try {
      await database.ref('games/' + code).set({
        host: playerName,
        guest: null,
        board: boardToString(INITIAL_BOARD),
        isWhiteTurn: true,
        lastMove: null,
        history: [],
        whiteCaptured: [],
        blackCaptured: [],
        winner: null,
        created: Date.now()
      });
      setGameCode(code);
      setMyColor('white');
      setMode('waiting');
      subscribe(code, 'white');
    } catch (e) {
      setError('Failed to create game: ' + e.message);
    }
  };

  const joinGame = async () => {
    if (!database) {
      setError('Firebase not connected. Check your internet.');
      return;
    }
    
    const code = inputCode.toUpperCase().trim();
    if (!code) return;
    setError('');
    
    try {
      const snap = await database.ref('games/' + code).once('value');
      const data = snap.val();
      
      if (!data) {
        setError('Game not found!');
        return;
      }
      if (data.guest) {
        setError('Game is full!');
        return;
      }
      
      await database.ref('games/' + code).update({ guest: playerName });
      setGameCode(code);
      setMyColor('black');
      setOpponent(data.host);
      setBoard(stringToBoard(data.board));
      setMode('playing');
      subscribe(code, 'black');
    } catch (e) {
      setError('Failed to join: ' + e.message);
    }
  };

  const notation = (from, to, piece, captured) => {
    const pc = piece.toLowerCase() === 'p' ? '' : piece.toUpperCase();
    return `${piece.toLowerCase() === 'p' && captured ? files[from[1]] : ''}${pc}${captured ? 'x' : ''}${files[to[1]]}${8 - to[0]}`;
  };

  const handleClick = async (r, c) => {
    if (winner || !database) return;
    
    const isMyTurn = (isWhiteTurn && myColor === 'white') || (!isWhiteTurn && myColor === 'black');
    if (!isMyTurn) return;

    const piece = board[r]?.[c];
    const isMyPiece = myColor === 'white' ? isWhitePiece(piece) : isBlackPiece(piece);

    if (selected) {
      const [sr, sc] = selected;
      if (validMoves.some(([vr, vc]) => vr === r && vc === c)) {
        // Make move
        const newBoard = deepCopyBoard(board);
        const captured = newBoard[r][c];
        const movingPiece = newBoard[sr][sc];
        newBoard[r][c] = movingPiece;
        newBoard[sr][sc] = null;
        
        const newHistory = [...history, notation([sr, sc], [r, c], movingPiece, captured)];
        const newWhiteCaptured = captured && myColor === 'white' ? [...whiteCaptured, captured] : whiteCaptured;
        const newBlackCaptured = captured && myColor === 'black' ? [...blackCaptured, captured] : blackCaptured;
        
        if (soundEnabled) captured ? playCapture() : playMove();
        
        const isKingCapture = captured?.toLowerCase() === 'k';
        
        try {
          await database.ref('games/' + gameCode).update({
            board: boardToString(newBoard),
            isWhiteTurn: !isWhiteTurn,
            lastMove: { from: [sr, sc], to: [r, c] },
            history: newHistory,
            whiteCaptured: newWhiteCaptured,
            blackCaptured: newBlackCaptured,
            winner: isKingCapture ? myColor : null
          });
          
          // Save to game history if game ended
          if (isKingCapture) {
            await database.ref('gameHistory/' + gameCode).set({
              gameCode: gameCode,
              whitePlayer: myColor === 'white' ? playerName : opponent,
              blackPlayer: myColor === 'black' ? playerName : opponent,
              winner: playerName,
              winnerColor: myColor,
              totalMoves: newHistory.length,
              completedAt: Date.now()
            });
          }
        } catch (e) {
          setError('Move failed: ' + e.message);
        }
        
        setSelected(null);
        setValidMoves([]);
      } else if (isMyPiece) {
        setSelected([r, c]);
        setValidMoves(getValidMoves(board, r, c));
      } else {
        setSelected(null);
        setValidMoves([]);
      }
    } else if (isMyPiece) {
      setSelected([r, c]);
      setValidMoves(getValidMoves(board, r, c));
    }
  };

  const copyCode = () => {
    navigator.clipboard?.writeText(gameCode);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  const [showConfirm, setShowConfirm] = useState(false);

  const leaveGame = () => {
    cleanup();
    setMode('menu');
    setGameCode('');
    setInputCode('');
    setMyColor(null);
    setOpponent('');
    setBoard(deepCopyBoard(INITIAL_BOARD));
    setIsWhiteTurn(true);
    setSelected(null);
    setValidMoves([]);
    setLastMove(null);
    setWinner(null);
    setHistory([]);
    setWhiteCaptured([]);
    setBlackCaptured([]);
    setError('');
    setShowConfirm(false);
  };

  const handleLeaveClick = () => {
    if (mode === 'playing' && !winner) {
      setShowConfirm(true);
    } else {
      leaveGame();
    }
  };

  // MENU
  if (mode === 'menu') {
    return (
      <div className="min-h-screen bg-black p-4 sm:p-6">
        <div className="max-w-md mx-auto">
          <button onClick={onBack} className="text-white/40 hover:text-white text-sm mb-8">‚Üê Back</button>
          
          <div className="text-center mb-10">
            <h1 className="text-2xl font-light tracking-widest text-white uppercase">Play Online</h1>
            <div className="w-12 h-px bg-white/30 mx-auto mt-4" />
            {database && (
              <div className="flex items-center justify-center gap-2 mt-4">
                <div className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse" />
                <span className="text-green-400/70 text-xs tracking-wide">Connected</span>
              </div>
            )}
          </div>
          
          {error && (
            <div className="border border-red-500/50 p-3 mb-6 text-red-400 text-sm text-center">
              {error}
            </div>
          )}
          
          <div className="space-y-4">
            <button onClick={createGame} className="w-full p-4 bg-white text-black hover:bg-white/90 transition-all group">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                  <span className="text-2xl">‚ôö</span>
                  <div className="text-left">
                    <h2 className="font-medium tracking-wide">Create Game</h2>
                    <p className="text-black/50 text-xs mt-0.5">Get a code to share</p>
                  </div>
                </div>
                <span className="text-black/40 group-hover:text-black/70">‚Üí</span>
              </div>
            </button>
            
            <div className="text-center text-white/30 text-sm py-2">or</div>
            
            <div className="border border-white/20 p-4">
              <h3 className="text-white/60 text-sm mb-3 tracking-wide">Join with Code</h3>
              <div className="flex gap-2">
                <input
                  type="text"
                  value={inputCode}
                  onChange={e => setInputCode(e.target.value.toUpperCase())}
                  placeholder="KNIGHT-1234"
                  className="flex-1 bg-transparent border-b border-white/30 focus:border-white px-2 py-2 text-white placeholder-white/30 focus:outline-none font-mono text-center uppercase transition-colors"
                  onKeyDown={e => e.key === 'Enter' && joinGame()}
                />
                <button onClick={joinGame} className="px-4 py-2 border border-white/30 text-white hover:bg-white hover:text-black transition-all">
                  Join
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // WAITING
  if (mode === 'waiting') {
    return (
      <div className="min-h-screen bg-black p-4 sm:p-6">
        <div className="max-w-md mx-auto text-center">
          <button onClick={leaveGame} className="text-white/40 hover:text-white text-sm mb-8 block mx-auto">‚Üê Cancel</button>
          
          <div className="mb-8">
            <div className="text-4xl mb-4 text-white animate-pulse">‚ôî</div>
            <h1 className="text-xl font-light tracking-wide text-white">Waiting for opponent</h1>
          </div>
          
          <div className="border border-white/20 p-6 mb-8">
            <p className="text-white/40 text-xs uppercase tracking-widest mb-3">Game Code</p>
            <div className="flex items-center justify-center gap-3">
              <span className="text-2xl font-mono font-light text-white tracking-widest">{gameCode}</span>
              <button onClick={copyCode} className="p-2 border border-white/20 hover:border-white/40 text-white/60 hover:text-white transition-all">
                {copied ? 'Copied' : 'Share'}
              </button>
            </div>
          </div>
          
          <div className="flex justify-center gap-3">
            <a href={`mailto:?subject=Chess Match&body=Join my game: ${gameCode}`} className="px-4 py-2 border border-white/20 text-white/60 hover:text-white hover:border-white/40 text-sm transition-all">
              Email
            </a>
            <a href={`https://wa.me/?text=Chess game code: ${gameCode}`} target="_blank" rel="noopener noreferrer" className="px-4 py-2 border border-white/20 text-white/60 hover:text-white hover:border-white/40 text-sm transition-all">
              WhatsApp
            </a>
            <button onClick={copyCode} className="px-4 py-2 border border-white/20 text-white/60 hover:text-white hover:border-white/40 text-sm transition-all">
              Copy
            </button>
          </div>
          
          <div className="mt-8 flex items-center justify-center gap-2 text-white/40 text-sm">
            <div className="w-1.5 h-1.5 bg-white/40 rounded-full animate-pulse" />
            Waiting...
          </div>
        </div>
      </div>
    );
  }

  // PLAYING
  const isMyTurn = (isWhiteTurn && myColor === 'white') || (!isWhiteTurn && myColor === 'black');
  const amIWhite = myColor === 'white';
  const displayBoard = amIWhite ? board : [...board].reverse().map(row => [...row].reverse());

  return (
    <div className="min-h-screen bg-black p-2 sm:p-4 lg:p-6">
      <ConfirmModal 
        show={showConfirm}
        title="Leave Game?"
        message="Your opponent will win if you leave now."
        onConfirm={leaveGame}
        onCancel={() => setShowConfirm(false)}
      />
      <div className="max-w-5xl mx-auto">
        <div className="mb-3 sm:mb-4">
          <button onClick={handleLeaveClick} className="text-white/40 hover:text-white text-xs sm:text-sm mb-2">‚Üê Leave</button>
          <div className="flex items-center gap-2 sm:gap-3 flex-wrap">
            <h1 className="text-lg sm:text-xl font-light tracking-wide text-white">Online Game</h1>
            <span className="text-[10px] sm:text-xs px-2 py-0.5 border border-white/20 text-white/60 font-mono">{gameCode}</span>
            <div className="flex items-center gap-1">
              <div className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse" />
              <span className="text-[10px] text-white/40">Live</span>
            </div>
          </div>
        </div>

        {error && (
          <div className="border border-red-500/50 p-2 mb-2 text-red-400 text-xs text-center">{error}</div>
        )}

        {winner && (
          <div className={`border p-3 mb-4 text-center ${winner === myColor ? 'border-white bg-white/10' : 'border-white/30'}`}>
            <p className="text-lg text-white">{winner === myColor ? 'You Win' : 'You Lost'}</p>
          </div>
        )}

        {/* Mobile: Opponent bar */}
        <div className="lg:hidden mb-2">
          <div className={`border p-2 flex items-center justify-between ${!isMyTurn && !winner ? 'border-white bg-white/5' : 'border-white/10'}`}>
            <div className="flex items-center gap-2">
              <div className={`w-3 h-3 rounded-full ${amIWhite ? 'bg-white/20 border border-white/40' : 'bg-white'}`} />
              <span className="text-white text-sm">{opponent || 'Opponent'}</span>
            </div>
            {!isMyTurn && !winner && <span className="text-white/50 text-xs animate-pulse">Their turn</span>}
          </div>
        </div>

        <div className="flex flex-col lg:flex-row gap-3 sm:gap-6 items-center lg:items-start">
          <div className="flex-shrink-0">
            <ChessBoard 
              board={displayBoard}
              selectedSquare={selected ? (amIWhite ? selected : [7 - selected[0], 7 - selected[1]]) : null}
              onSquareClick={(r, c) => handleClick(amIWhite ? r : 7 - r, amIWhite ? c : 7 - c)}
              lastMove={lastMove ? {
                from: amIWhite ? lastMove.from : [7 - lastMove.from[0], 7 - lastMove.from[1]],
                to: amIWhite ? lastMove.to : [7 - lastMove.to[0], 7 - lastMove.to[1]]
              } : null}
              validMoves={amIWhite ? validMoves : validMoves.map(([r, c]) => [7 - r, 7 - c])}
              disabled={!isMyTurn || !!winner}
              theme={boardTheme}
            />
          </div>

          {/* Mobile: My info bar */}
          <div className="lg:hidden w-full">
            <div className={`border p-2 flex items-center justify-between ${isMyTurn && !winner ? 'border-white bg-white/5' : 'border-white/10'}`}>
              <div className="flex items-center gap-2">
                <div className={`w-3 h-3 rounded-full ${amIWhite ? 'bg-white' : 'bg-white/20 border border-white/40'}`} />
                <span className="text-white text-sm">{playerName}</span>
                <span className="text-[10px] text-white/40">You</span>
              </div>
              {isMyTurn && !winner && <span className="text-white/70 text-xs animate-pulse">Your turn</span>}
            </div>
          </div>

          <button onClick={handleLeaveClick} className="lg:hidden w-full py-2 border border-white/20 text-white/60 hover:text-white text-sm transition-all">Leave Game</button>

          {/* Desktop sidebar */}
          <div className="hidden lg:block flex-1 w-full max-w-xs space-y-3">
            <div className={`border p-3 ${!isMyTurn && !winner ? 'border-white bg-white/5' : 'border-white/10'}`}>
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center gap-2">
                  <div className={`w-3 h-3 rounded-full ${amIWhite ? 'bg-white/20 border border-white/40' : 'bg-white'}`} />
                  <span className="text-white text-sm">{opponent || 'Opponent'}</span>
                </div>
              </div>
              <CapturedPieces pieces={amIWhite ? blackCaptured : whiteCaptured} />
            </div>

            {!winner && (
              <div className={`border p-3 text-center ${isMyTurn ? 'border-white bg-white/5' : 'border-white/10'}`}>
                <p className={`${isMyTurn ? 'text-white' : 'text-white/50'}`}>
                  {isMyTurn ? 'Your turn' : `Waiting for ${opponent}...`}
                </p>
              </div>
            )}

            {winner && (
              <div className={`border p-4 text-center ${winner === myColor ? 'border-white bg-white/10' : 'border-white/30'}`}>
                <p className="text-lg text-white">{winner === myColor ? 'Victory' : 'Defeat'}</p>
              </div>
            )}

            <div className={`border p-3 ${isMyTurn && !winner ? 'border-white bg-white/5' : 'border-white/10'}`}>
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center gap-2">
                  <div className={`w-3 h-3 rounded-full ${amIWhite ? 'bg-white' : 'bg-white/20 border border-white/40'}`} />
                  <span className="text-white text-sm">{playerName}</span>
                  <span className="text-[10px] border border-white/20 px-1 text-white/50">You</span>
                </div>
              </div>
              <CapturedPieces pieces={amIWhite ? whiteCaptured : blackCaptured} />
            </div>

            <div className="border border-white/10 p-3 max-h-32 overflow-y-auto">
              <p className="text-white/30 text-xs uppercase mb-2 tracking-wide">Moves</p>
              <div className="space-y-1 font-mono text-xs">
                {!history.length && <p className="text-white/20">No moves yet</p>}
                {Array.from({ length: Math.ceil(history.length / 2) }).map((_, i) => (
                  <div key={i} className="flex gap-2">
                    <span className="text-white/30 w-4">{i + 1}.</span>
                    <span className="text-white w-12">{history[i * 2]}</span>
                    <span className="text-white/50">{history[i * 2 + 1] || ''}</span>
                  </div>
                ))}
              </div>
            </div>

            <button onClick={handleLeaveClick} className="w-full py-2.5 border border-white/20 text-white/60 hover:text-white hover:border-white/40 transition-all">Leave Game</button>
          </div>
        </div>
      </div>
    </div>
  );
}
// Opening trainer components
function DemoMode({ opening, onComplete, onSkip, soundEnabled, voiceEnabled }) {
  const [idx, setIdx] = useState(0);
  const [playing, setPlaying] = useState(false);
  const [waiting, setWaiting] = useState(false);
  const { speak, stop, isSpeaking } = useSpeech();
  const { playMove } = useSound();
  const timerRef = useRef(null);
  const board = getBoardAtMove(opening.moves, idx);
  const last = idx > 0 ? opening.moves[idx - 1] : null;
  const voice = idx > 0 ? opening.moves[idx - 1].voice : null;

  useEffect(() => {
    if (timerRef.current) clearTimeout(timerRef.current);
    if (!playing || waiting || idx >= opening.moves.length) return;
    timerRef.current = setTimeout(() => {
      if (soundEnabled) playMove();
      setIdx(i => i + 1);
      if (voiceEnabled && opening.moves[idx]?.voice) { setWaiting(true); speak(opening.moves[idx].voice, () => setWaiting(false)); }
    }, idx === 0 ? 600 : 800);
    return () => clearTimeout(timerRef.current);
  }, [playing, waiting, idx, opening.moves, soundEnabled, voiceEnabled, playMove, speak]);

  useEffect(() => { if (idx >= opening.moves.length) setPlaying(false); }, [idx, opening.moves.length]);

  const toggle = () => { if (idx >= opening.moves.length) { stop(); setWaiting(false); setIdx(0); setTimeout(() => setPlaying(true), 100); } else { if (playing) { stop(); setWaiting(false); } setPlaying(!playing); } };
  const seek = i => { stop(); setWaiting(false); setIdx(Math.max(0, Math.min(opening.moves.length, i))); setPlaying(false); };
  const next = () => { stop(); setWaiting(false); setPlaying(false); if (idx < opening.moves.length) { if (soundEnabled) playMove(); setIdx(idx + 1); if (voiceEnabled && opening.moves[idx]?.voice) speak(opening.moves[idx].voice); } };
  const prev = () => { stop(); setWaiting(false); setIdx(i => Math.max(0, i - 1)); setPlaying(false); };

  return (
    <div className="min-h-screen bg-black p-4 sm:p-6">
      <div className="max-w-5xl mx-auto">
        <div className="mb-6">
          <button onClick={() => { stop(); onSkip(); }} className="text-white/40 hover:text-white text-sm mb-4">‚Üê Back</button>
          <div className="flex items-center gap-3">
            <h1 className="text-xl font-light tracking-wide text-white">{opening.name}</h1>
            <span className="text-xs px-2 py-1 border border-white/20 text-white/60">Demo</span>
          </div>
        </div>
        <div className="flex flex-col lg:flex-row gap-6 items-start">
          <ChessBoard board={board} lastMove={last} disabled />
          <div className="flex-1 max-w-xs w-full space-y-4">
            <div className="border border-white/10 p-4">
              <div className="flex items-center gap-3 mb-3">
                <div className="w-8 h-8 border border-white/20 flex items-center justify-center text-white/60">‚ôî</div>
                <div>
                  <p className="text-white text-sm">Coach</p>
                  {isSpeaking && <p className="text-white/40 text-xs">Speaking...</p>}
                </div>
              </div>
              <p className="text-white/70 text-sm leading-relaxed min-h-[40px]">{voice || "Press play to begin."}</p>
              {idx > 0 && <p className="text-white/40 text-xs mt-3 font-mono">Move {idx}: {opening.moves[idx - 1]?.notation}</p>}
            </div>
            <div className="border border-white/10 p-4">
              <div className="mb-4">
                <div className="h-1 bg-white/10 cursor-pointer" onClick={e => { const r = e.currentTarget.getBoundingClientRect(); seek(Math.round(((e.clientX - r.left) / r.width) * opening.moves.length)); }}>
                  <div className="h-full bg-white transition-all" style={{ width: `${(idx / opening.moves.length) * 100}%` }} />
                </div>
                <div className="flex justify-between text-xs text-white/40 mt-2"><span>{idx}/{opening.moves.length}</span></div>
              </div>
              <div className="flex items-center justify-center gap-3">
                <button onClick={prev} disabled={idx === 0} className="p-2 text-white/40 hover:text-white disabled:text-white/20">
                  <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                </button>
                <button onClick={toggle} className="p-3 bg-white text-black hover:bg-white/90">
                  {playing ? <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg> : <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>}
                </button>
                <button onClick={next} disabled={idx >= opening.moves.length} className="p-2 text-white/40 hover:text-white disabled:text-white/20">
                  <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                </button>
              </div>
            </div>
            {idx >= opening.moves.length && <button onClick={() => { stop(); onComplete(); }} className="w-full py-3 bg-white text-black font-medium tracking-wide uppercase text-sm hover:bg-white/90">Practice Now ‚Üí</button>}
          </div>
        </div>
      </div>
    </div>
  );
}

function PracticeMode({ opening, onBack, onRewatch, soundEnabled, onComplete }) {
  const [board, setBoard] = useState(deepCopyBoard(INITIAL_BOARD));
  const [selected, setSelected] = useState(null);
  const [idx, setIdx] = useState(0);
  const [msg, setMsg] = useState('');
  const [msgType, setMsgType] = useState('info');
  const [last, setLast] = useState(null);
  const [hint, setHint] = useState(false);
  const [stats, setStats] = useState({ ok: 0, err: 0 });
  const [done, setDone] = useState(false);
  const { playMove, playGameEnd, playError } = useSound();

  useEffect(() => { if (opening.playerColor === 'black') setTimeout(() => compMove(0), 500); else setMsg("Your move"); }, []);

  const compMove = i => {
    if (i >= opening.moves.length) return;
    const m = opening.moves[i];
    if (soundEnabled) playMove();
    setBoard(b => { const n = deepCopyBoard(b); n[m.to[0]][m.to[1]] = n[m.from[0]][m.from[1]]; n[m.from[0]][m.from[1]] = null; return n; });
    setLast(m); setIdx(i + 1);
    if (i + 1 >= opening.moves.length) { setDone(true); setMsg("Perfect!"); setMsgType('success'); if (soundEnabled) playGameEnd(); onComplete?.(); }
    else { setMsg("Your move"); setMsgType('info'); }
  };

  const handleClick = (r, c) => {
    if (done || idx >= opening.moves.length) return;
    const exp = opening.moves[idx], isTurn = (idx % 2 === 0) === (opening.playerColor === 'white');
    if (!isTurn) return;
    if (selected) {
      const [fr, fc] = selected, p = board[fr][fc];
      if (fr === exp.from[0] && fc === exp.from[1] && r === exp.to[0] && c === exp.to[1]) {
        if (soundEnabled) playMove();
        const nb = deepCopyBoard(board); nb[r][c] = p; nb[fr][fc] = null;
        setBoard(nb); setLast(exp); setIdx(idx + 1); setStats(s => ({ ...s, ok: s.ok + 1 })); setHint(false);
        if (idx + 1 >= opening.moves.length) { setDone(true); setMsg("Perfect!"); setMsgType('success'); if (soundEnabled) playGameEnd(); onComplete?.(); }
        else { setMsg("Correct!"); setMsgType('success'); setTimeout(() => compMove(idx + 1), 500); }
      } else if (r === fr && c === fc) setSelected(null);
      else if (board[r][c] && (opening.playerColor === 'white' ? isWhitePiece(board[r][c]) : isBlackPiece(board[r][c]))) setSelected([r, c]);
      else { if (soundEnabled) playError(); setMsg("Try again"); setMsgType('error'); setStats(s => ({ ...s, err: s.err + 1 })); setSelected(null); }
    } else if (board[r][c] && (opening.playerColor === 'white' ? isWhitePiece(board[r][c]) : isBlackPiece(board[r][c]))) setSelected([r, c]);
  };

  const files = ['a','b','c','d','e','f','g','h'], sq = (r, c) => `${files[c]}${8 - r}`;
  const restart = () => { setBoard(deepCopyBoard(INITIAL_BOARD)); setSelected(null); setIdx(0); setMsg(''); setLast(null); setHint(false); setDone(false); setStats({ ok: 0, err: 0 }); if (opening.playerColor === 'black') setTimeout(() => compMove(0), 500); else setMsg("Your move"); };

  return (
    <div className="min-h-screen bg-black p-4 sm:p-6">
      <div className="max-w-5xl mx-auto">
        <div className="mb-6">
          <button onClick={onBack} className="text-white/40 hover:text-white text-sm mb-4">‚Üê Back</button>
          <div className="flex items-center gap-3">
            <h1 className="text-xl font-light tracking-wide text-white">{opening.name}</h1>
            <span className="text-xs px-2 py-1 border border-white/20 text-white/60">Practice</span>
          </div>
          <p className="text-white/40 text-sm mt-2">Playing as {opening.playerColor}</p>
        </div>
        <div className="flex flex-col lg:flex-row gap-6 items-start">
          <ChessBoard board={board} selectedSquare={selected} onSquareClick={handleClick} lastMove={last} disabled={false} />
          <div className="flex-1 max-w-xs w-full space-y-4">
            <div className={`border p-4 text-center ${msgType === 'success' ? 'border-white bg-white/10' : msgType === 'error' ? 'border-red-500/50 bg-red-500/10' : 'border-white/10'}`}>
              <p className={`text-lg ${msgType === 'success' ? 'text-white' : msgType === 'error' ? 'text-red-400' : 'text-white/70'}`}>{msg || 'Select a piece'}</p>
            </div>
            <div className="border border-white/10 p-4">
              <div className="h-1 bg-white/10 mb-3"><div className="h-full bg-white transition-all" style={{ width: `${(idx / opening.moves.length) * 100}%` }} /></div>
              <div className="flex justify-between text-sm">
                <span className="text-white/60">{stats.ok} correct</span>
                <span className="text-white/40">{stats.err} wrong</span>
              </div>
            </div>
            {!done && (
              <button onClick={() => setHint(!hint)} className={`w-full py-3 border transition-all ${hint ? 'border-white bg-white/10 text-white' : 'border-white/20 text-white/50 hover:border-white/40'}`}>
                {hint ? 'Hide hint' : 'Show hint'}
              </button>
            )}
            {hint && !done && idx < opening.moves.length && (
              <div className="border border-white/20 p-4 text-center">
                <p className="text-white font-mono">{opening.moves[idx].notation}</p>
                <p className="text-white/40 text-xs mt-1">{sq(...opening.moves[idx].from)} ‚Üí {sq(...opening.moves[idx].to)}</p>
              </div>
            )}
            <div className="space-y-2">
              <button onClick={onRewatch} className="w-full py-3 border border-white/20 text-white/60 hover:text-white hover:border-white/40 transition-all">Rewatch Demo</button>
              <button onClick={restart} className="w-full py-3 border border-white/20 text-white/60 hover:text-white hover:border-white/40 transition-all">Restart</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function OpeningSelect({ onSelect, onBack, progress, onResetProgress }) {
  const done = Object.keys(progress).filter(k => progress[k]?.completed).length, total = Object.keys(OPENINGS).length;
  const [showReset, setShowReset] = useState(false);
  
  return (
    <div className="min-h-screen bg-black p-4 sm:p-6">
      <div className="max-w-4xl mx-auto">
        <button onClick={onBack} className="text-white/40 hover:text-white text-sm mb-6">‚Üê Back</button>
        <div className="text-center mb-8">
          <h1 className="text-2xl font-light tracking-widest text-white uppercase mb-2">Learn Openings</h1>
          <div className="w-12 h-px bg-white/30 mx-auto mt-4 mb-6" />
          <div className="max-w-xs mx-auto">
            <div className="flex justify-between text-xs text-white/40 mb-2"><span>Progress</span><span>{done}/{total}</span></div>
            <div className="h-1 bg-white/10"><div className="h-full bg-white transition-all" style={{ width: `${(done / total) * 100}%` }} /></div>
          </div>
          {done > 0 && (
            <button onClick={() => setShowReset(true)} className="text-white/30 hover:text-white/60 text-xs mt-3">Reset progress</button>
          )}
        </div>
        
        {showReset && (
          <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
            <div className="bg-neutral-900 border border-white/20 p-6 max-w-sm">
              <h3 className="text-lg font-light text-white mb-2">Reset Progress?</h3>
              <p className="text-white/50 text-sm mb-6">This will clear all your completed openings.</p>
              <div className="flex gap-3">
                <button onClick={() => setShowReset(false)} className="flex-1 py-2.5 border border-white/30 text-white/70 hover:text-white">Cancel</button>
                <button onClick={() => { onResetProgress(); setShowReset(false); }} className="flex-1 py-2.5 bg-white text-black">Reset</button>
              </div>
            </div>
          </div>
        )}
        
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          {Object.entries(OPENINGS).map(([k, o]) => (
            <button key={k} onClick={() => onSelect(k)} className="group text-left p-4 border border-white/10 hover:border-white/30 transition-all relative">
              {progress[k]?.completed && <span className="absolute top-3 right-3 text-white/60">‚úì</span>}
              <h3 className="text-base font-light text-white group-hover:text-white/80 mb-1">{o.name}</h3>
              <p className="text-white/40 text-xs mb-3">{o.description}</p>
              <div className="flex gap-2">
                <span className={`text-xs px-2 py-0.5 ${o.playerColor === 'white' ? 'bg-white text-black' : 'bg-white/10 text-white/60 border border-white/20'}`}>{o.playerColor}</span>
                <span className="text-xs px-2 py-0.5 bg-white/5 text-white/40">{o.moves.length} moves</span>
              </div>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
}

// Witty greetings for returning players
const GREETINGS = [
  "Back for more? Your pieces missed you! üéØ",
  "The board awaits, champion! ‚ôüÔ∏è",
  "Ready to sacrifice some pawns for glory? üòà",
  "Let's turn some pawns into queens today! üëë",
  "Your opponent's king is getting nervous... üò∞",
  "Time to checkmate and chill! üßä",
  "The chess gods smile upon your return! ‚ö°",
  "Another day, another chance for brilliance! ‚ú®",
  "Your pieces have been practicing while you were gone! üí™",
  "Legend says you're unbeatable today... üèÜ",
  "Ready to make Magnus Carlsen jealous? üòé",
  "The 64 squares of destiny await! üé≤",
  "Plot twist: You're the main character today! üåü",
  "Time to turn caffeine into checkmates! ‚òï",
  "Your knight is ready to jump into action! üê¥"
];

// Famous chess quotes
const CHESS_QUOTES = [
  { quote: "Chess is life in miniature.", author: "Garry Kasparov" },
  { quote: "Every chess master was once a beginner.", author: "Irving Chernev" },
  { quote: "The beauty of chess is it can be whatever you want it to be.", author: "Simon Williams" },
  { quote: "Chess is the gymnasium of the mind.", author: "Blaise Pascal" },
  { quote: "In chess, as in life, forethought wins.", author: "Charles Buxton" },
  { quote: "Chess holds its master in its own bonds.", author: "Albert Einstein" },
  { quote: "Chess is everything: art, science, and sport.", author: "Anatoly Karpov" },
  { quote: "When you see a good move, look for a better one.", author: "Emanuel Lasker" },
  { quote: "Chess is a war over the board.", author: "Bobby Fischer" },
  { quote: "The pawns are the soul of chess.", author: "Fran√ßois-Andr√© Philidor" },
  { quote: "Chess makes men wiser and clear-sighted.", author: "Vladimir Putin" },
  { quote: "I don't believe in psychology. I believe in good moves.", author: "Bobby Fischer" },
  { quote: "Chess is mental torture.", author: "Garry Kasparov" },
  { quote: "Tactics is knowing what to do when there is something to do.", author: "Savielly Tartakower" },
  { quote: "Chess is a forcing house where the weights of character are tested.", author: "Reuben Fine" }
];

// Pro tips for chess improvement
const PRO_TIPS = [
  "üí° Control the center with your pawns and pieces early in the game.",
  "üí° Develop your knights and bishops before moving the same piece twice.",
  "üí° Castle early to protect your king and connect your rooks.",
  "üí° Don't bring your queen out too early - she can become a target.",
  "üí° Every move should have a purpose: develop, attack, or defend.",
  "üí° Knights are stronger in closed positions, bishops in open ones.",
  "üí° Rooks belong on open files and the 7th rank.",
  "üí° A knight on the rim is grim - keep knights centralized.",
  "üí° When ahead in material, trade pieces. When behind, trade pawns.",
  "üí° The threat is stronger than the execution - keep your opponent guessing.",
  "üí° Always ask: What is my opponent's threat?",
  "üí° Doubled pawns are usually a weakness - avoid them when possible.",
  "üí° Passed pawns must be pushed! They can become queens.",
  "üí° In the endgame, activate your king - he's a fighting piece!",
  "üí° Time is a piece too - don't waste it on unnecessary moves."
];

function getRandomItem(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function NameEntry({ initialName, onSubmit }) {
  const [name, setName] = useState(initialName);
  return (
    <div className="min-h-screen bg-black flex items-center justify-center p-6">
      <div className="max-w-sm w-full text-center">
        {/* Elegant chess piece */}
        <div className="mb-8">
          <div className="text-7xl mb-4 text-white">‚ôî</div>
          <h1 className="text-3xl font-light tracking-widest text-white uppercase">Chess</h1>
          <div className="w-16 h-px bg-white/30 mx-auto mt-4" />
        </div>
        
        <div className="space-y-4">
          <input 
            type="text" 
            value={name} 
            onChange={e => setName(e.target.value)} 
            placeholder="Enter your name" 
            className="w-full bg-transparent border-b-2 border-white/30 focus:border-white px-4 py-3 text-white text-center text-lg placeholder-white/40 focus:outline-none transition-colors" 
            autoFocus 
            onKeyDown={e => e.key === 'Enter' && name.trim() && onSubmit(name.trim())} 
          />
          <button 
            onClick={() => name.trim() && onSubmit(name.trim())} 
            disabled={!name.trim()} 
            className="w-full py-3 bg-white text-black font-medium tracking-wide uppercase text-sm hover:bg-white/90 disabled:bg-white/20 disabled:text-white/40 transition-all"
          >
            Begin
          </button>
        </div>
      </div>
    </div>
  );
}

function SettingsButton({ onClick }) {
  return (
    <button onClick={onClick} className="fixed top-4 right-4 p-2.5 bg-black/50 hover:bg-black border border-white/20 hover:border-white/40 rounded-full text-white/60 hover:text-white transition-all z-40">
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    </button>
  );
}

// Confirmation Modal for quitting
function ConfirmModal({ show, title, message, onConfirm, onCancel }) {
  if (!show) return null;
  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
      <div className="bg-neutral-900 border border-white/20 p-6 max-w-sm w-full text-center">
        <h3 className="text-white text-lg font-light tracking-wide mb-2">{title}</h3>
        <p className="text-white/60 text-sm mb-6">{message}</p>
        <div className="flex gap-3">
          <button onClick={onCancel} className="flex-1 py-2.5 border border-white/30 text-white/70 hover:text-white hover:border-white/50 transition-all text-sm uppercase tracking-wide">
            Cancel
          </button>
          <button onClick={onConfirm} className="flex-1 py-2.5 bg-white text-black hover:bg-white/90 transition-all text-sm uppercase tracking-wide font-medium">
            Leave
          </button>
        </div>
      </div>
    </div>
  );
}

function SettingsModal({ show, onClose, soundEnabled, setSoundEnabled, voiceEnabled, setVoiceEnabled, onChangeName, onResetProgress, prefs, updatePrefs }) {
  if (!show) return null;
  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
      <div className="bg-neutral-900 border border-white/20 p-6 max-w-xs w-full max-h-[90vh] overflow-y-auto">
        <div className="flex items-center justify-between mb-6">
          <h3 className="text-lg font-light tracking-wide text-white">Settings</h3>
          <button onClick={onClose} className="text-white/40 hover:text-white text-xl">√ó</button>
        </div>
        <div className="space-y-3">
          <button onClick={() => setSoundEnabled(!soundEnabled)} className={`w-full py-3 border text-sm tracking-wide transition-all ${soundEnabled ? 'bg-white text-black border-white' : 'bg-transparent border-white/30 text-white/60 hover:border-white/50'}`}>
            {soundEnabled ? '‚ô™ Sound On' : '‚ô™ Sound Off'}
          </button>
          <button onClick={() => setVoiceEnabled(!voiceEnabled)} className={`w-full py-3 border text-sm tracking-wide transition-all ${voiceEnabled ? 'bg-white text-black border-white' : 'bg-transparent border-white/30 text-white/60 hover:border-white/50'}`}>
            {voiceEnabled ? '‚óâ Voice On' : '‚óã Voice Off'}
          </button>
          
          {/* Board Theme */}
          {prefs && (
            <>
              <div className="h-px bg-white/10 my-4" />
              <p className="text-white/40 text-xs uppercase tracking-wider mb-2">Board Theme</p>
              <div className="grid grid-cols-3 gap-2">
                {Object.entries(BOARD_THEMES).map(([key, theme]) => (
                  <button
                    key={key}
                    onClick={() => updatePrefs({ boardTheme: key })}
                    className={`p-2 border text-xs transition-all ${prefs.boardTheme === key ? 'border-white bg-white/10 text-white' : 'border-white/20 text-white/50 hover:border-white/40'}`}
                  >
                    <div className="flex gap-0.5 justify-center mb-1">
                      <div className={`w-3 h-3 ${theme.light}`} />
                      <div className={`w-3 h-3 ${theme.dark}`} />
                    </div>
                    {theme.name}
                  </button>
                ))}
              </div>
            </>
          )}
          
          <div className="h-px bg-white/10 my-4" />
          <button onClick={onChangeName} className="w-full py-3 border border-white/30 text-white/60 text-sm tracking-wide hover:border-white/50 hover:text-white transition-all">
            Change Name
          </button>
          <button onClick={onResetProgress} className="w-full py-3 border border-red-500/50 text-red-400 text-sm tracking-wide hover:border-red-500 hover:text-red-300 transition-all">
            Reset Progress
          </button>
        </div>
        <button onClick={onClose} className="w-full mt-6 py-3 bg-white text-black text-sm tracking-wide uppercase font-medium hover:bg-white/90 transition-all">Done</button>
      </div>
    </div>
  );
}

// Game control buttons - Undo, Rematch, Share
function GameControls({ onUndo, onRematch, onShare, canUndo, showRematch, gameCode }) {
  const [copied, setCopied] = useState(false);
  
  const handleShare = () => {
    const url = gameCode ? `${window.location.origin}${window.location.pathname}?join=${gameCode}` : window.location.href;
    if (navigator.share) {
      navigator.share({ title: 'Chess Game', text: gameCode ? `Join my chess game: ${gameCode}` : 'Play chess with me!', url });
    } else {
      navigator.clipboard?.writeText(gameCode ? `Join my chess game: ${gameCode}\n${url}` : url);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    }
    onShare?.();
  };
  
  return (
    <div className="flex gap-2">
      {onUndo && (
        <button 
          onClick={onUndo} 
          disabled={!canUndo}
          className={`flex-1 py-2.5 border text-sm transition-all ${canUndo ? 'border-white/30 text-white/70 hover:border-white/50 hover:text-white' : 'border-white/10 text-white/20 cursor-not-allowed'}`}
        >
          ‚Ü∂ Undo
        </button>
      )}
      {showRematch && onRematch && (
        <button 
          onClick={onRematch}
          className="flex-1 py-2.5 bg-white text-black text-sm font-medium hover:bg-white/90 transition-all"
        >
          ‚Üª Rematch
        </button>
      )}
      {onShare !== undefined && (
        <button 
          onClick={handleShare}
          className="flex-1 py-2.5 border border-white/30 text-white/70 hover:border-white/50 hover:text-white text-sm transition-all"
        >
          {copied ? '‚úì Copied' : '‚Üó Share'}
        </button>
      )}
    </div>
  );
}

// Game History Component - shows all completed online games
function GameHistory({ onBack }) {
  const [games, setGames] = useState([]);
  const [loading, setLoading] = useState(true);
  const database = window.firebaseDatabase;

  useEffect(() => {
    if (!database) {
      setLoading(false);
      return;
    }

    const historyRef = database.ref('gameHistory');
    historyRef.orderByChild('completedAt').limitToLast(50).once('value')
      .then(snapshot => {
        const data = snapshot.val();
        if (data) {
          const gamesList = Object.entries(data).map(([id, game]) => ({ id, ...game }));
          gamesList.sort((a, b) => b.completedAt - a.completedAt);
          setGames(gamesList);
        }
        setLoading(false);
      })
      .catch(() => setLoading(false));
  }, []);

  const formatDate = (timestamp) => {
    const date = new Date(timestamp);
    return date.toLocaleDateString('en-US', { 
      month: 'short', 
      day: 'numeric',
      year: 'numeric'
    });
  };

  const formatTime = (timestamp) => {
    const date = new Date(timestamp);
    return date.toLocaleTimeString('en-US', { 
      hour: 'numeric', 
      minute: '2-digit',
      hour12: true 
    });
  };

  return (
    <div className="min-h-screen bg-black p-4 sm:p-6">
      <div className="max-w-lg mx-auto">
        <button onClick={onBack} className="text-white/40 hover:text-white text-sm mb-6">‚Üê Back</button>
        
        <div className="text-center mb-8">
          <h1 className="text-2xl font-light tracking-widest text-white uppercase">History</h1>
          <div className="w-12 h-px bg-white/30 mx-auto mt-4" />
        </div>

        {loading ? (
          <div className="text-center py-12">
            <p className="text-white/40">Loading...</p>
          </div>
        ) : games.length === 0 ? (
          <div className="text-center py-12 border border-white/10">
            <p className="text-white/40">No games yet</p>
            <p className="text-white/20 text-sm mt-2">Complete an online match to see it here</p>
          </div>
        ) : (
          <div className="space-y-3">
            {games.map(game => (
              <div key={game.id} className="border border-white/10 p-4 hover:border-white/20 transition-all">
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <span className="text-white font-medium">{game.winner}</span>
                    <span className="text-white/30 text-sm">won</span>
                  </div>
                  <span className="text-xs text-white/30 font-mono">{game.gameCode}</span>
                </div>
                
                <div className="flex items-center gap-3 mb-3 text-sm">
                  <div className="flex items-center gap-2">
                    <div className="w-2 h-2 rounded-full bg-white" />
                    <span className={game.winnerColor === 'white' ? 'text-white' : 'text-white/50'}>
                      {game.whitePlayer}
                    </span>
                  </div>
                  <span className="text-white/20">vs</span>
                  <div className="flex items-center gap-2">
                    <div className="w-2 h-2 rounded-full bg-white/30 border border-white/50" />
                    <span className={game.winnerColor === 'black' ? 'text-white' : 'text-white/50'}>
                      {game.blackPlayer}
                    </span>
                  </div>
                </div>
                
                <div className="flex items-center justify-between text-xs text-white/30">
                  <span>{formatDate(game.completedAt)}</span>
                  <span>{formatTime(game.completedAt)}</span>
                  <span>{game.totalMoves} moves</span>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

function MainMenu({ playerName, onPlay, onMultiplayer, onOnline, onLearn, onHistory, onDaily, onStories, onArticle, onChangeName, soundEnabled, setSoundEnabled, voiceEnabled, setVoiceEnabled, onResetProgress, stats, streak, prefs, updatePrefs }) {
  const [showSettings, setShowSettings] = useState(false);
  const [quote] = useState(() => getRandomItem(CHESS_QUOTES));
  
  const winRate = stats.gamesPlayed > 0 ? Math.round((stats.wins / stats.gamesPlayed) * 100) : 0;
  
  return (
    <div className="min-h-screen bg-black p-4 sm:p-6">
      <SettingsButton onClick={() => setShowSettings(true)} />
      <SettingsModal 
        show={showSettings} 
        onClose={() => setShowSettings(false)} 
        soundEnabled={soundEnabled} 
        setSoundEnabled={setSoundEnabled} 
        voiceEnabled={voiceEnabled} 
        setVoiceEnabled={setVoiceEnabled}
        onChangeName={() => { setShowSettings(false); onChangeName(); }}
        onResetProgress={() => { onResetProgress(); setShowSettings(false); }}
        prefs={prefs}
        updatePrefs={updatePrefs}
      />
      
      <div className="max-w-md mx-auto pt-6 sm:pt-10">
        {/* Header */}
        <div className="text-center mb-6">
          <div className="text-6xl sm:text-7xl mb-4 text-white">‚ôî</div>
          <h1 className="text-2xl sm:text-3xl font-light tracking-[0.3em] text-white uppercase">Chess</h1>
          <div className="w-12 h-px bg-white/30 mx-auto mt-4 mb-3" />
          <p className="text-white/40 text-sm tracking-wide">Welcome, {playerName}</p>
        </div>
        
        {/* Daily Streak Banner */}
        {streak && streak.current > 0 && (
          <div className="mb-4 p-3 border border-amber-500/30 bg-amber-500/10 text-center">
            <p className="text-amber-400 text-sm">üî• {streak.current} day streak!</p>
            {streak.best > streak.current && <p className="text-amber-400/50 text-xs mt-1">Best: {streak.best} days</p>}
          </div>
        )}
        
        {/* Stats Bar */}
        {stats.gamesPlayed > 0 && (
          <div className="flex justify-center gap-6 mb-6 text-center">
            <div>
              <p className="text-white text-lg font-light">{stats.wins}</p>
              <p className="text-white/30 text-xs tracking-wide">Wins</p>
            </div>
            <div className="w-px bg-white/10" />
            <div>
              <p className="text-white text-lg font-light">{stats.losses}</p>
              <p className="text-white/30 text-xs tracking-wide">Losses</p>
            </div>
            <div className="w-px bg-white/10" />
            <div>
              <p className="text-white text-lg font-light">{winRate}%</p>
              <p className="text-white/30 text-xs tracking-wide">Win Rate</p>
            </div>
          </div>
        )}
        
        {/* Quote */}
        <div className="mb-6 text-center px-4">
          <p className="text-white/50 text-sm italic leading-relaxed">"{quote.quote}"</p>
          <p className="text-white/30 text-xs mt-2">‚Äî {quote.author}</p>
        </div>
        
        {/* Daily Puzzle - Featured */}
        <button onClick={onDaily} className={`w-full p-4 mb-4 border transition-all group ${streak?.todayCompleted ? 'border-white/20' : 'border-amber-500/50 bg-amber-500/5 hover:bg-amber-500/10'}`}>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <span className="text-2xl">‚ö°</span>
              <div className="text-left">
                <h2 className={`font-light tracking-wide ${streak?.todayCompleted ? 'text-white/60' : 'text-amber-400'}`}>Daily Puzzle</h2>
                <p className="text-white/40 text-xs mt-0.5">{streak?.todayCompleted ? 'Completed today ‚úì' : 'New puzzle available'}</p>
              </div>
            </div>
            <span className="text-white/30 group-hover:text-white/60">‚Üí</span>
          </div>
        </button>
        
        {/* Main Actions - Play Buttons with colored accents */}
        <div className="space-y-3 mb-4">
          <button onClick={onPlay} className="w-full p-4 border border-white/20 hover:border-white/40 hover:bg-white/5 transition-all group border-l-2 border-l-emerald-500">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <span className="text-2xl text-emerald-400">‚ôü</span>
                <div className="text-left">
                  <h2 className="text-white font-light tracking-wide">Play vs Computer</h2>
                  <p className="text-white/40 text-xs mt-0.5">5 difficulty levels</p>
                </div>
              </div>
              <span className="text-white/30 group-hover:text-emerald-400">‚Üí</span>
            </div>
          </button>
          
          <button onClick={onOnline} className="w-full p-4 border border-white/20 hover:border-white/40 hover:bg-white/5 transition-all group border-l-2 border-l-cyan-500">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <span className="text-2xl text-cyan-400">‚ôö</span>
                <div className="text-left">
                  <h2 className="text-white font-light tracking-wide">Play Online</h2>
                  <p className="text-white/40 text-xs mt-0.5">Challenge a friend</p>
                </div>
              </div>
              <span className="text-white/30 group-hover:text-cyan-400">‚Üí</span>
            </div>
          </button>
          
          <button onClick={onMultiplayer} className="w-full p-4 border border-white/20 hover:border-white/40 hover:bg-white/5 transition-all group border-l-2 border-l-violet-500">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <span className="text-2xl text-violet-400">‚ôú</span>
                <div className="text-left">
                  <h2 className="text-white font-light tracking-wide">Local Match</h2>
                  <p className="text-white/40 text-xs mt-0.5">Two players, one device</p>
                </div>
              </div>
              <span className="text-white/30 group-hover:text-violet-400">‚Üí</span>
            </div>
          </button>
        </div>
        
        {/* Secondary Actions */}
        <div className="grid grid-cols-4 gap-2 mb-6">
          <button onClick={onLearn} className="p-3 border border-white/10 hover:border-white/30 transition-all text-center">
            <span className="text-lg text-white/60">‚ôû</span>
            <p className="text-white/50 text-xs mt-1 tracking-wide">Learn</p>
          </button>
          <button onClick={onStories} className="p-3 border border-white/10 hover:border-white/30 transition-all text-center">
            <span className="text-lg text-white/60">üìñ</span>
            <p className="text-white/50 text-xs mt-1 tracking-wide">Stories</p>
          </button>
          <button onClick={onArticle} className="p-3 border border-white/10 hover:border-white/30 transition-all text-center">
            <span className="text-lg text-white/60">üì∞</span>
            <p className="text-white/50 text-xs mt-1 tracking-wide">Today</p>
          </button>
          <button onClick={onHistory} className="p-3 border border-white/10 hover:border-white/30 transition-all text-center">
            <span className="text-lg text-white/60">‚ò∞</span>
            <p className="text-white/50 text-xs mt-1 tracking-wide">History</p>
          </button>
        </div>
        
        {/* Version */}
        <p className="text-center text-white/20 text-xs tracking-wider">v2.0</p>
      </div>
    </div>
  );
}

// Daily Puzzle Screen
function DailyPuzzle({ onBack, onComplete, soundEnabled, streak }) {
  const puzzle = getTodaysPuzzle();
  const [board, setBoard] = useState(puzzle.board.map(row => [...row]));
  const [selected, setSelected] = useState(null);
  const [solved, setSolved] = useState(streak?.todayCompleted || false);
  const [showHint, setShowHint] = useState(false);
  const [attempts, setAttempts] = useState(0);
  const { playMove, playGameEnd, playError } = useSound();
  
  const handleClick = (r, c) => {
    if (solved) return;
    
    if (selected) {
      const [sr, sc] = selected;
      if (sr === puzzle.solution.from[0] && sc === puzzle.solution.from[1] &&
          r === puzzle.solution.to[0] && c === puzzle.solution.to[1]) {
        const newBoard = board.map(row => [...row]);
        newBoard[r][c] = newBoard[sr][sc];
        newBoard[sr][sc] = null;
        setBoard(newBoard);
        setSolved(true);
        if (soundEnabled) playGameEnd();
        onComplete();
      } else if (board[r][c] && isWhitePiece(board[r][c])) {
        setSelected([r, c]);
      } else {
        setAttempts(a => a + 1);
        if (soundEnabled) playError();
        setSelected(null);
      }
    } else if (board[r][c] && isWhitePiece(board[r][c])) {
      setSelected([r, c]);
    }
  };
  
  return (
    <div className="min-h-screen bg-black p-4 sm:p-6">
      <div className="max-w-5xl mx-auto">
        <div className="mb-6">
          <button onClick={onBack} className="text-white/40 hover:text-white text-sm mb-4">‚Üê Back</button>
          <div className="flex items-center gap-3">
            <h1 className="text-xl font-light tracking-wide text-white">Daily Puzzle</h1>
            <span className="text-xs px-2 py-1 border border-amber-500/50 text-amber-400">{puzzle.type.replace(/_/g, ' ')}</span>
          </div>
          <p className="text-white/40 text-sm mt-2">{puzzle.name}</p>
        </div>
        
        <div className="flex flex-col lg:flex-row gap-6 items-start">
          <ChessBoard board={board} selectedSquare={selected} onSquareClick={handleClick} disabled={solved} />
          
          <div className="flex-1 max-w-xs w-full space-y-4">
            {solved ? (
              <div className="border border-white bg-white/10 p-4 text-center">
                <p className="text-lg text-white mb-2">Solved!</p>
                <p className="text-white/60 text-sm">{puzzle.explanation}</p>
              </div>
            ) : (
              <div className="border border-white/10 p-4 text-center">
                <p className="text-white/70">White to move</p>
                <p className="text-white/40 text-sm mt-1">Find the best move</p>
              </div>
            )}
            
            {!solved && (
              <>
                <button onClick={() => setShowHint(!showHint)} className={`w-full py-3 border transition-all ${showHint ? 'border-white bg-white/10 text-white' : 'border-white/20 text-white/50 hover:border-white/40'}`}>
                  {showHint ? 'Hide Hint' : 'Show Hint'}
                </button>
                {showHint && (
                  <div className="border border-white/20 p-4 text-center">
                    <p className="text-white/70 text-sm">{puzzle.hint}</p>
                  </div>
                )}
                {attempts > 0 && <p className="text-white/40 text-xs text-center">Attempts: {attempts}</p>}
              </>
            )}
            
            {streak && (
              <div className="border border-white/10 p-3 text-center">
                <p className="text-white/40 text-xs uppercase tracking-wide mb-1">Streak</p>
                <p className="text-2xl text-white">{streak.current} üî•</p>
                {streak.best > 0 && <p className="text-white/30 text-xs mt-1">Best: {streak.best}</p>}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

// Chess Stories Selection Screen
function ChessStoriesSelect({ onSelect, onBack }) {
  return (
    <div className="min-h-screen bg-black p-4 sm:p-6">
      <div className="max-w-4xl mx-auto">
        <button onClick={onBack} className="text-white/40 hover:text-white text-sm mb-6">‚Üê Back</button>
        <div className="text-center mb-8">
          <h1 className="text-2xl font-light tracking-widest text-white uppercase mb-2">Chess Stories</h1>
          <div className="w-12 h-px bg-white/30 mx-auto mt-4" />
          <p className="text-white/40 text-sm mt-4">Relive the greatest games in history</p>
        </div>
        
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {Object.entries(CHESS_STORIES).map(([key, story]) => (
            <button key={key} onClick={() => onSelect(key)} className="text-left p-5 border border-white/10 hover:border-white/30 transition-all group">
              <p className="text-white/40 text-xs mb-2">{story.year}</p>
              <h3 className="text-white font-light text-lg mb-1 group-hover:text-white/80">{story.name}</h3>
              <p className="text-white/50 text-sm mb-3">{story.players}</p>
              <p className="text-white/30 text-xs line-clamp-2">{story.description}</p>
              <span className={`inline-block mt-3 text-xs px-2 py-0.5 border ${
                story.difficulty === 'beginner' ? 'border-green-500/50 text-green-400' :
                story.difficulty === 'intermediate' ? 'border-yellow-500/50 text-yellow-400' :
                'border-red-500/50 text-red-400'
              }`}>{story.difficulty}</span>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
}

// Chess Story Viewer
function ChessStoryViewer({ storyKey, onBack, soundEnabled }) {
  const story = CHESS_STORIES[storyKey];
  const [idx, setIdx] = useState(0);
  const { playMove } = useSound();
  
  const board = getBoardAtMove(story.moves.map(m => ({ from: m.from, to: m.to })), idx);
  const currentMove = idx > 0 ? story.moves[idx - 1] : null;
  
  const next = () => {
    if (idx < story.moves.length) {
      if (soundEnabled) playMove();
      setIdx(idx + 1);
    }
  };
  const prev = () => setIdx(Math.max(0, idx - 1));
  
  return (
    <div className="min-h-screen bg-black p-4 sm:p-6">
      <div className="max-w-5xl mx-auto">
        <div className="mb-6">
          <button onClick={onBack} className="text-white/40 hover:text-white text-sm mb-4">‚Üê Back</button>
          <h1 className="text-xl font-light tracking-wide text-white">{story.name}</h1>
          <p className="text-white/40 text-sm mt-1">{story.players}, {story.year}</p>
        </div>
        
        {idx === 0 && (
          <div className="border border-white/20 p-6 mb-6 text-center">
            <p className="text-white/70 italic">{story.intro}</p>
          </div>
        )}
        
        <div className="flex flex-col lg:flex-row gap-6 items-start">
          <ChessBoard board={board} lastMove={idx > 0 ? { from: story.moves[idx-1].from, to: story.moves[idx-1].to } : null} disabled />
          
          <div className="flex-1 max-w-xs w-full space-y-4">
            {currentMove && (
              <div className="border border-white/20 p-4">
                <p className="text-white/40 text-xs uppercase mb-2">Move {idx}</p>
                <p className="text-white font-mono text-lg mb-2">{currentMove.notation}</p>
                <p className="text-white/60 text-sm">{currentMove.story}</p>
              </div>
            )}
            
            <div className="border border-white/10 p-3">
              <div className="h-1 bg-white/10 mb-3">
                <div className="h-full bg-white transition-all" style={{ width: `${(idx / story.moves.length) * 100}%` }} />
              </div>
              <div className="flex justify-between text-xs text-white/40">
                <span>Move {idx}/{story.moves.length}</span>
              </div>
            </div>
            
            <div className="flex gap-2">
              <button onClick={prev} disabled={idx === 0} className={`flex-1 py-3 border transition-all ${idx === 0 ? 'border-white/10 text-white/20' : 'border-white/30 text-white/70 hover:border-white/50'}`}>
                ‚Üê Prev
              </button>
              <button onClick={next} disabled={idx >= story.moves.length} className={`flex-1 py-3 border transition-all ${idx >= story.moves.length ? 'border-white/10 text-white/20' : 'border-white/30 text-white/70 hover:border-white/50'}`}>
                Next ‚Üí
              </button>
            </div>
            
            {idx >= story.moves.length && (
              <div className="border border-white bg-white/10 p-4 text-center">
                <p className="text-white">Story Complete</p>
                <button onClick={onBack} className="mt-3 px-6 py-2 bg-white text-black text-sm">Back to Stories</button>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

// Daily Dashboard - Comprehensive chess knowledge hub with tiles
function DailyDashboard({ onBack }) {
  const content = getDailyContent();
  const today = new Date();
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const [selectedTile, setSelectedTile] = useState(null);
  
  // Detail view for a tile
  if (selectedTile) {
    return (
      <div className="min-h-screen bg-black p-4 sm:p-6">
        <div className="max-w-lg mx-auto">
          <button onClick={() => setSelectedTile(null)} className="text-white/40 hover:text-white text-sm mb-6">‚Üê Back to Dashboard</button>
          
          {selectedTile === 'history' && (
            <div>
              <div className="flex items-center gap-3 mb-6">
                <span className="text-3xl">üìÖ</span>
                <div>
                  <p className="text-amber-400 text-xs uppercase tracking-wide">Today in History</p>
                  <h1 className="text-xl text-white font-light">{content.history.title}</h1>
                </div>
              </div>
              <div className="border border-amber-500/30 bg-amber-500/5 p-6">
                <p className="text-amber-400 text-2xl font-light mb-4">{content.history.year}</p>
                <p className="text-white/70 leading-relaxed">{content.history.content}</p>
              </div>
            </div>
          )}
          
          {selectedTile === 'piece' && (
            <div>
              <div className="flex items-center gap-3 mb-6">
                <span className="text-4xl">{content.piece.symbol}</span>
                <div>
                  <p className="text-cyan-400 text-xs uppercase tracking-wide">Piece of the Day</p>
                  <h1 className="text-xl text-white font-light">The {content.piece.piece}</h1>
                </div>
              </div>
              <div className="space-y-4">
                <div className="border border-cyan-500/30 bg-cyan-500/5 p-4">
                  <p className="text-cyan-400/60 text-xs uppercase mb-1">Value</p>
                  <p className="text-white text-lg">{content.piece.value}</p>
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <div className="border border-white/10 p-4">
                    <p className="text-emerald-400 text-xs uppercase mb-2">Strengths</p>
                    <p className="text-white/60 text-sm">{content.piece.strengths}</p>
                  </div>
                  <div className="border border-white/10 p-4">
                    <p className="text-red-400 text-xs uppercase mb-2">Weaknesses</p>
                    <p className="text-white/60 text-sm">{content.piece.weaknesses}</p>
                  </div>
                </div>
                <div className="border border-white/10 p-4">
                  <p className="text-yellow-400 text-xs uppercase mb-2">Pro Tips</p>
                  <p className="text-white/70 text-sm">{content.piece.tips}</p>
                </div>
                <div className="border border-white/10 p-4">
                  <p className="text-white/40 text-xs uppercase mb-2">Famous Move</p>
                  <p className="text-white/50 text-sm italic">{content.piece.famousMove}</p>
                </div>
              </div>
            </div>
          )}
          
          {selectedTile === 'opening' && (
            <div>
              <div className="flex items-center gap-3 mb-6">
                <span className="text-3xl">üìñ</span>
                <div>
                  <p className="text-emerald-400 text-xs uppercase tracking-wide">Opening Spotlight</p>
                  <h1 className="text-xl text-white font-light">{content.opening.name}</h1>
                </div>
              </div>
              <div className="space-y-4">
                <div className="border border-emerald-500/30 bg-emerald-500/5 p-4 font-mono text-lg text-white">
                  {content.opening.moves}
                </div>
                <p className="text-white/70">{content.opening.idea}</p>
                <div className="border border-white/10 p-4">
                  <p className="text-emerald-400 text-xs uppercase mb-3">Key Ideas</p>
                  <ul className="space-y-2">
                    {content.opening.keyIdeas.map((idea, i) => (
                      <li key={i} className="text-white/60 text-sm flex gap-2">
                        <span className="text-emerald-400">‚Ä¢</span> {idea}
                      </li>
                    ))}
                  </ul>
                </div>
                <p className="text-white/40 text-sm">Best for: {content.opening.bestFor}</p>
              </div>
            </div>
          )}
          
          {selectedTile === 'legend' && (
            <div>
              <div className="flex items-center gap-3 mb-6">
                <span className="text-3xl">üë§</span>
                <div>
                  <p className="text-violet-400 text-xs uppercase tracking-wide">Chess Legend</p>
                  <h1 className="text-xl text-white font-light">{content.legend.name}</h1>
                </div>
              </div>
              <div className="space-y-4">
                <div className="flex flex-wrap gap-2">
                  <span className="px-3 py-1 border border-violet-500/30 bg-violet-500/10 text-violet-400 text-sm">{content.legend.title}</span>
                  <span className="px-3 py-1 border border-white/20 text-white/60 text-sm">{content.legend.years}</span>
                  <span className="px-3 py-1 border border-white/20 text-white/60 text-sm">Peak: {content.legend.peak}</span>
                </div>
                <div className="border border-white/10 p-4">
                  <p className="text-violet-400 text-xs uppercase mb-2">Playing Style</p>
                  <p className="text-white/70">{content.legend.style}</p>
                </div>
                <div className="border border-white/10 p-4">
                  <p className="text-white/40 text-xs uppercase mb-2">Achievement</p>
                  <p className="text-white/60">{content.legend.achievement}</p>
                </div>
                <div className="border border-violet-500/30 bg-violet-500/5 p-4">
                  <p className="text-white/80 text-lg italic">"{content.legend.quote}"</p>
                </div>
              </div>
            </div>
          )}
          
          {selectedTile === 'tactic' && (
            <div>
              <div className="flex items-center gap-3 mb-6">
                <span className="text-3xl">{content.tactic.symbol}</span>
                <div>
                  <p className="text-red-400 text-xs uppercase tracking-wide">Tactical Pattern</p>
                  <h1 className="text-xl text-white font-light">{content.tactic.name}</h1>
                </div>
              </div>
              <div className="space-y-4">
                <div className="border border-red-500/30 bg-red-500/5 p-4">
                  <p className="text-white/80">{content.tactic.description}</p>
                </div>
                <div className="border border-white/10 p-4">
                  <p className="text-red-400 text-xs uppercase mb-2">How to Execute</p>
                  <p className="text-white/60 text-sm">{content.tactic.howTo}</p>
                </div>
                <div className="border border-white/10 p-4">
                  <p className="text-yellow-400 text-xs uppercase mb-2">Example</p>
                  <p className="text-white/50 text-sm italic">{content.tactic.example}</p>
                </div>
                <div className="border border-white/10 p-4">
                  <p className="text-emerald-400 text-xs uppercase mb-2">How to Defend</p>
                  <p className="text-white/60 text-sm">{content.tactic.defense}</p>
                </div>
                <span className="inline-block px-3 py-1 border border-white/20 text-white/40 text-sm">{content.tactic.difficulty}</span>
              </div>
            </div>
          )}
          
          {selectedTile === 'wisdom' && (
            <div>
              <div className="flex items-center gap-3 mb-6">
                <span className="text-3xl">üí°</span>
                <div>
                  <p className="text-yellow-400 text-xs uppercase tracking-wide">Chess Wisdom</p>
                </div>
              </div>
              <div className="space-y-4">
                <div className="border border-yellow-500/30 bg-yellow-500/5 p-6">
                  <p className="text-white text-xl font-light italic leading-relaxed">"{content.wisdom.quote}"</p>
                  <p className="text-yellow-400 mt-4">‚Äî {content.wisdom.author}</p>
                </div>
                <div className="border border-white/10 p-4">
                  <p className="text-yellow-400 text-xs uppercase mb-2">What This Means</p>
                  <p className="text-white/60 leading-relaxed">{content.wisdom.context}</p>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    );
  }
  
  // Main dashboard tile view
  return (
    <div className="min-h-screen bg-black p-4 sm:p-6">
      <div className="max-w-2xl mx-auto">
        <button onClick={onBack} className="text-white/40 hover:text-white text-sm mb-4">‚Üê Back</button>
        
        {/* Header */}
        <div className="text-center mb-6">
          <h1 className="text-2xl font-light tracking-wide text-white mb-1">Daily Chess</h1>
          <p className="text-white/40 text-sm">{dayNames[today.getDay()]}, {monthNames[today.getMonth()]} {today.getDate()}</p>
        </div>
        
        {/* Tiles Grid */}
        <div className="grid grid-cols-2 gap-3">
          {/* Today in History - Featured large tile */}
          <button 
            onClick={() => setSelectedTile('history')} 
            className="col-span-2 p-5 border border-amber-500/30 bg-amber-500/5 hover:bg-amber-500/10 transition-all text-left group"
          >
            <div className="flex items-start justify-between">
              <div className="flex-1">
                <div className="flex items-center gap-2 mb-2">
                  <span className="text-2xl">üìÖ</span>
                  <span className="text-amber-400 text-xs uppercase tracking-wide">Today in History</span>
                </div>
                <p className="text-white font-light text-lg">{content.history.title}</p>
                <p className="text-amber-400/60 text-sm mt-1">{content.history.year}</p>
              </div>
              <span className="text-white/20 group-hover:text-white/40 text-xl">‚Üí</span>
            </div>
          </button>
          
          {/* Piece of the Day */}
          <button 
            onClick={() => setSelectedTile('piece')} 
            className="p-4 border border-cyan-500/30 bg-cyan-500/5 hover:bg-cyan-500/10 transition-all text-left group"
          >
            <span className="text-3xl block mb-2">{content.piece.symbol}</span>
            <p className="text-cyan-400 text-xs uppercase tracking-wide mb-1">Piece of the Day</p>
            <p className="text-white font-light">The {content.piece.piece}</p>
          </button>
          
          {/* Opening Spotlight */}
          <button 
            onClick={() => setSelectedTile('opening')} 
            className="p-4 border border-emerald-500/30 bg-emerald-500/5 hover:bg-emerald-500/10 transition-all text-left group"
          >
            <span className="text-3xl block mb-2">üìñ</span>
            <p className="text-emerald-400 text-xs uppercase tracking-wide mb-1">Opening Spotlight</p>
            <p className="text-white font-light">{content.opening.name}</p>
          </button>
          
          {/* Chess Legend */}
          <button 
            onClick={() => setSelectedTile('legend')} 
            className="p-4 border border-violet-500/30 bg-violet-500/5 hover:bg-violet-500/10 transition-all text-left group"
          >
            <span className="text-3xl block mb-2">üë§</span>
            <p className="text-violet-400 text-xs uppercase tracking-wide mb-1">Chess Legend</p>
            <p className="text-white font-light">{content.legend.name}</p>
          </button>
          
          {/* Tactical Pattern */}
          <button 
            onClick={() => setSelectedTile('tactic')} 
            className="p-4 border border-red-500/30 bg-red-500/5 hover:bg-red-500/10 transition-all text-left group"
          >
            <span className="text-3xl block mb-2">{content.tactic.symbol}</span>
            <p className="text-red-400 text-xs uppercase tracking-wide mb-1">Tactical Pattern</p>
            <p className="text-white font-light">{content.tactic.name}</p>
          </button>
          
          {/* Chess Wisdom - Full width */}
          <button 
            onClick={() => setSelectedTile('wisdom')} 
            className="col-span-2 p-5 border border-yellow-500/30 bg-yellow-500/5 hover:bg-yellow-500/10 transition-all text-left group"
          >
            <div className="flex items-center gap-2 mb-2">
              <span className="text-2xl">üí°</span>
              <span className="text-yellow-400 text-xs uppercase tracking-wide">Chess Wisdom</span>
            </div>
            <p className="text-white/80 italic">"{content.wisdom.quote}"</p>
            <p className="text-yellow-400/60 text-sm mt-2">‚Äî {content.wisdom.author}</p>
          </button>
        </div>
        
        {/* Footer */}
        <div className="mt-6 text-center">
          <p className="text-white/20 text-xs">Content refreshes daily</p>
        </div>
      </div>
    </div>
  );
}

const ChessApp = function ChessApp() {
  const [screen, setScreen] = useState('name');
  const [opening, setOpening] = useState(null);
  const [storyKey, setStoryKey] = useState(null);
  const [soundEnabled, setSoundEnabled] = useState(true);
  const [voiceEnabled, setVoiceEnabled] = useState(true);
  const { name, saveName, clearName } = usePlayerName();
  const { progress, markCompleted, resetProgress } = useProgress();
  const { stats, recordWin, recordLoss, resetStats } = useGameStats();
  const { prefs, updatePrefs } = usePreferences();
  const database = typeof window !== 'undefined' ? window.firebaseDatabase : null;
  const { streak, completeDaily } = useDailyStreak(name, database);

  useEffect(() => { if (name) setScreen('menu'); }, []);

  const handleChangeName = () => { clearName(); setScreen('name'); };

  if (screen === 'name' || !name) return <NameEntry initialName={name} onSubmit={n => { saveName(n); setScreen('menu'); }} />;
  if (screen === 'menu') return <MainMenu playerName={name} onPlay={() => setScreen('play')} onMultiplayer={() => setScreen('multiplayer')} onOnline={() => setScreen('online')} onLearn={() => setScreen('openings')} onHistory={() => setScreen('history')} onDaily={() => setScreen('daily')} onStories={() => setScreen('stories')} onArticle={() => setScreen('article')} onChangeName={handleChangeName} soundEnabled={soundEnabled} setSoundEnabled={setSoundEnabled} voiceEnabled={voiceEnabled} setVoiceEnabled={setVoiceEnabled} onResetProgress={resetProgress} stats={stats} streak={streak} prefs={prefs} updatePrefs={updatePrefs} />;
  if (screen === 'play') return <PlayMatch playerName={name} onBack={() => setScreen('menu')} soundEnabled={soundEnabled} onWin={recordWin} onLoss={recordLoss} boardTheme={prefs.boardTheme} />;
  if (screen === 'multiplayer') return <PlayMultiplayer player1Name={name} onBack={() => setScreen('menu')} soundEnabled={soundEnabled} boardTheme={prefs.boardTheme} />;
  if (screen === 'online') return <PlayOnline playerName={name} onBack={() => setScreen('menu')} soundEnabled={soundEnabled} onWin={recordWin} onLoss={recordLoss} boardTheme={prefs.boardTheme} />;
  if (screen === 'history') return <GameHistory onBack={() => setScreen('menu')} />;
  if (screen === 'daily') return <DailyPuzzle onBack={() => setScreen('menu')} onComplete={completeDaily} soundEnabled={soundEnabled} streak={streak} />;
  if (screen === 'stories') return <ChessStoriesSelect onSelect={k => { setStoryKey(k); setScreen('story'); }} onBack={() => setScreen('menu')} />;
  if (screen === 'story' && storyKey) return <ChessStoryViewer storyKey={storyKey} onBack={() => setScreen('stories')} soundEnabled={soundEnabled} />;
  if (screen === 'article') return <DailyDashboard onBack={() => setScreen('menu')} />;
  if (screen === 'openings') return <OpeningSelect onSelect={k => { setOpening(k); setScreen('demo'); }} onBack={() => setScreen('menu')} progress={progress} onResetProgress={resetProgress} />;
  if (screen === 'demo' && opening) return <DemoMode opening={OPENINGS[opening]} onComplete={() => setScreen('practice')} onSkip={() => setScreen('practice')} soundEnabled={soundEnabled} voiceEnabled={voiceEnabled} />;
  if (screen === 'practice' && opening) return <PracticeMode opening={OPENINGS[opening]} onBack={() => setScreen('openings')} onRewatch={() => setScreen('demo')} soundEnabled={soundEnabled} onComplete={() => markCompleted(opening)} />;
  return null;
}

ReactDOM.createRoot(document.getElementById('root')).render(<ChessApp />);
  </script>
</body>
</html>
